<!DOCTYPE html><html lang="zh_CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 在 Ubuntu 服务器上搭建 OpenConnect 服务器小记 · Phoenix's island</title><meta name="description" content="在 Ubuntu 服务器上搭建 OpenConnect 服务器小记 - Phoenix Nemo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/null"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.phoenixlzx.com/atom.xml" title="Phoenix's island"><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="Phoenix's island" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/static/img/avatar/avatar.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINKS</a></li><li class="nav-list-item"><a href="https://github.com/phoenixlzx" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">在 Ubuntu 服务器上搭建 OpenConnect 服务器小记</h1><div class="post-info">2014年7月21日</div><div class="post-content"><p>最近猫给推荐的 Cisco AnyConnect，面基的时候也看到 Aveline 菊苣在用 AnyConnect(插嘴：正太菊苣果然好可爱！！！) 于是自己折腾了下。作为少有的能让我折腾起来的 VPN，暂且把搭建步骤简单记录下。</p>
<a id="more"></a>

<p>AnyConnect 的好处是基于 HTTPS，证书可以申请 StartSSL 的，而且配置也不很复杂。另外配置文件里发现了很多专门为商业化/企业服务定制的选项，例如最大同时在线客户端数量，同账户最大在线设备数量等等。</p>
<p>OpenConnect 是 AnyConnect 的开源实现。目前 0.8.0 版本需要 GnuTLS 3.1 以上版本，所以我们就直接在 Ubuntu 14.04 中搭建。另外 就算是基于 HTTPS，这货也是要用 TUN 设备的，所以 OpenVZ 用户们请注意。</p>
<h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get install build-essential libwrap0-dev libpam0g-dev libdbus-1-dev \</span><br><span class="line">  libreadline-dev libnl-route-3-dev libprotobuf-c0-dev libpcl1-dev libopts25-dev \</span><br><span class="line">  autogen libgnutls28 libgnutls28-dev libseccomp-dev libhttp-parser-dev</span><br></pre></td></tr></table></figure>

<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>下载源码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget -c ftp://ftp.infradead.org/pub/ocserv/ocserv-0.8.0.tar.xz</span><br><span class="line">tar xvf ocserv-0.8.0.tar.xz</span><br><span class="line"><span class="built_in">cd</span> ocserv-0.8.0</span><br></pre></td></tr></table></figure>

<p>编译安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/opt/ocserv </span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line">mkdir /opt/ocserv/etc/</span><br><span class="line">cp doc/sample.config /opt/ocserv/etc/config</span><br></pre></td></tr></table></figure>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>这里只记录需要修改的重点配置，其他配置请参照样例配置文件的注释按需修改。</p>
<p>文件 <code>/opt/ocserv/etc/config</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">auth</span> = <span class="string">&quot;plain[/opt/ocserv/etc/passwd]&quot;</span></span><br><span class="line"><span class="attr">listen-host</span> = connect.your.domain</span><br><span class="line"><span class="attr">max-clients</span> = <span class="number">128</span></span><br><span class="line"><span class="attr">max-same-clients</span> = <span class="number">4</span></span><br><span class="line"><span class="attr">server-cert</span> = /opt/ocserv/etc/ssl/server-cert.pem</span><br><span class="line"><span class="attr">server-key</span> = /opt/ocserv/etc/ssl/server-key.pem</span><br><span class="line"><span class="attr">ca-cert</span> = /opt/ocserv/etc/ssl/ca.pem</span><br><span class="line"><span class="attr">mobile-idle-timeout</span> = <span class="number">2400</span></span><br><span class="line"><span class="attr">ipv4-network</span> = <span class="number">192.168</span>.<span class="number">1.0</span></span><br><span class="line"><span class="attr">ipv4-netmask</span> = <span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line"><span class="attr">dns</span> = <span class="number">8.8</span>.<span class="number">8.8</span></span><br><span class="line"><span class="attr">dns</span> = <span class="number">8.8</span>.<span class="number">4.4</span></span><br><span class="line"><span class="attr">route</span> = <span class="number">192.168</span>.<span class="number">1.0</span>/<span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line"><span class="attr">route-add-cmd</span> = <span class="string">&quot;ip route add 192.168.1.0 dev tun0&quot;</span></span><br><span class="line"><span class="attr">route-del-cmd</span> = <span class="string">&quot;ip route delete 192.168.1.0 dev tun0&quot;</span></span><br></pre></td></tr></table></figure>

<p>创建用户，命令</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/opt/</span>ocserv<span class="regexp">/bin/</span>ocpasswd -c <span class="regexp">/opt/</span>ocserv<span class="regexp">/etc/</span>passwd username</span><br></pre></td></tr></table></figure>

<p>按提示输入两次密码。</p>
<p>iptables 规则</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t<span class="built_in"> nat </span>-A POSTROUTING -j SNAT --to-source &lt;server ip&gt; -o &lt;nic&gt;</span><br></pre></td></tr></table></figure>

<p>记得把 <code>&lt;server ip&gt;</code> 和 <code>&lt;nic&gt;</code> 改为服务器公网 IP 和对应网卡的名称。</p>
<h3 id="搞定"><a href="#搞定" class="headerlink" title="搞定"></a>搞定</h3><p>折腾完毕，AnyConnect 客户端可以成功使用了。</p>
<p><del>不过呢折腾完之后发现这货其实被干扰得很厉害啊…</del></p>
</div></article></div></section><footer><div class="paginator"><a href="/2014/09/02/2014-natsu/" class="prev">上一篇</a><a href="/2014/05/23/iptables-rate-limiting-rules-to-block-dns-amplification-attack/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'phoenixhexo';
var disqus_identifier = '2014/07/21/setup-openconnect-server-on-ubuntu/';
var disqus_title = '在 Ubuntu 服务器上搭建 OpenConnect 服务器小记';
var disqus_url = 'https://blog.phoenixlzx.com/2014/07/21/setup-openconnect-server-on-ubuntu/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//phoenixhexo.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2021 <a href="https://blog.phoenixlzx.com">Phoenix Nemo</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><!--script(async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML")--><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-48847648-1",'auto');ga('send','pageview');</script></body></html>