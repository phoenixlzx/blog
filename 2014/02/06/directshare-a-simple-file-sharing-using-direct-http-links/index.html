<!DOCTYPE html><html lang="zh_CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Directshare - 一个简单的HTTP直链文件分享工具 · Phoenix's island</title><meta name="description" content="Directshare - 一个简单的HTTP直链文件分享工具 - Phoenix Nemo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/null"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.phoenixlzx.com/atom.xml" title="Phoenix's island"><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="Phoenix's island" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/static/img/avatar/avatar.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINKS</a></li><li class="nav-list-item"><a href="https://github.com/phoenixlzx" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Directshare - 一个简单的HTTP直链文件分享工具</h1><div class="post-info">2014年2月6日</div><div class="post-content"><p>嘛… 最近真心补番补多了智商降得有点厉害.. 直到我发现自己已经看不懂别人的 js 代码，却还会手贱点开 bilibili 之后才<a target="_blank" rel="noopener" href="https://plus.google.com/107142103119739092775/posts/M2LA33yfdRG">立下军令状</a>，再不开新坑再不敲代码就敲不出来啦！</p>
<a id="more"></a>

<p>一直很纠结再写点啥。之前财务管理系统的坑估计要弃，因为实在一个人填不完…然后 NAE 一直没计划好，估计这个坑会更巨。之前 luke 酱说发现了一个不错的东方音乐站，想要个桌面端。咱之前有试着学Qt但是一直没有方便的文档而且..终归是咱能力不行吧，Qt估计是一时半会搞不定了。写桌面端的话，似乎只有 node-webkit 了.. 然后看了一下午的文档只有一个感觉——我要死了。</p>
<p><del>Intel开发的东西和红帽一样蛋疼</del></p>
<p>桌面端什么的…. 所以就放着吧… 随便搞个东西练练手算了。想想看还没有练习过文件上传 <del>真丢人啊都不会写文件上传</del> 于是来写一个上传文件并分享的东西好了w</p>
<p>于是老样子.. <code>express -e</code> 新建一个项目模板，初始化git仓库… 诶似乎有什么东西不对？</p>
<p><code>express.bodyParser()</code> 没了…</p>
<p>先不管这些，基本的路由和功能堆起来，打印出结果来看看能不能正确获取文件信息。然后… 当然失败了。</p>
<p>没有 <code>bodyParser</code> 之后，带有文件上传的表单无法被处理了，<code>req.files</code> 是 <code>undefined</code>，<code>req.body</code> 里也是空的..</p>
<p>一阵 Google 之后表示，泥煤的 express 3.4.x 又改了… <code>bodyParser</code> 已经被<a target="_blank" rel="noopener" href="https://groups.google.com/forum/#!topic/express-js/iP2VyhkypHo">弃用</a>，原因是存在<a target="_blank" rel="noopener" href="http://andrewkelley.me/post/do-not-use-bodyparser-with-express-js.html">可能占满磁盘的漏洞</a>。目前推荐的方式是直接使用 <code>multiparty</code>。于是又去翻这货的文档，表示要蛋疼许多… 纠结了一会觉得还是先用回 3.3.4 之后慢慢折腾下 multiparty。</p>
<p>Directshare 使用 HTTP 直链文件，看起来似乎有点危险，不过毕竟可以拿来做图床、临时的文件共享或者在没有FTP/SSH的情况下把文件上传到服务器什么的.. 最重要的是，<del>我只是想练练手而已搞那么复杂干嘛..</del></p>
<p>基本思路：整个程序分为负责接收文件的master和负责分发文件的cluster。客户端使用浏览器POST方法上传文件 =&gt; master得到文件后计算SHA256并把文件从临时目录移动到保存文件的目录，文件名是SHA256值，不带有后缀。接下来通知所有cluster来拖。这里要有一个验证，暂且用 POST accesskey 之类的东西来做好了。因为似乎没找到啥能通过 http 同步的 node 包，所以简单的双向 POST 数据基本上也没问题。本来想在cluster接收到文件后再计算一次hash值.. 不过这个后面再说。通知所有 cluster 用了一个 forEach，虽然是阻塞的方法不过发几个post请求应该是相当快的。接下来把从cluster下载文件的地址返回给客户端浏览器。这个时候cluster应该已经收到post请求，过来拖文件了。</p>
<p>文件 <code>master.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Module dependencies.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config.js&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">&#x27;querystring&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// all environments</span></span><br><span class="line">app.set(<span class="string">&#x27;port&#x27;</span>, config.port || <span class="number">3000</span>);</span><br><span class="line">app.set(<span class="string">&#x27;views&#x27;</span>, path.join(__dirname, <span class="string">&#x27;views&#x27;</span>));</span><br><span class="line">app.set(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>);</span><br><span class="line">app.use(express.favicon());</span><br><span class="line">app.use(express.logger(<span class="string">&#x27;dev&#x27;</span>));</span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.bodyParser(&#123;</span><br><span class="line">    keepExtensions: <span class="literal">false</span>,</span><br><span class="line">    uploadDir: <span class="string">&quot;tmpdata&quot;</span></span><br><span class="line">&#125;));</span><br><span class="line">app.use(express.methodOverride());</span><br><span class="line"><span class="comment">// app.use(app.router);</span></span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">&#x27;public&#x27;</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// development only</span></span><br><span class="line"><span class="keyword">if</span> (<span class="string">&#x27;development&#x27;</span> == app.get(<span class="string">&#x27;env&#x27;</span>)) &#123;</span><br><span class="line">  app.use(express.errorHandler());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.render(<span class="string">&#x27;index&#x27;</span>, &#123;</span><br><span class="line">        siteName: config.siteName</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// console.log(req.files.uploadfile);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// hash file with sha256</span></span><br><span class="line">    <span class="keyword">var</span> sha256sum = crypto.createHash(<span class="string">&#x27;sha256&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> filehash = fs.ReadStream(req.files.uploadfile.path);</span><br><span class="line">    filehash.on(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">        sha256sum.update(d);</span><br><span class="line">    &#125;);</span><br><span class="line">    filehash.on(<span class="string">&#x27;end&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> d = sha256sum.digest(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(d + <span class="string">&#x27; &#x27;</span> + req.files.uploadfile.name);</span><br><span class="line">        <span class="comment">// move file to storage location</span></span><br><span class="line">        fs.rename(req.files.uploadfile.path, <span class="string">&#x27;files/&#x27;</span> + d, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// notify clusters to fetch file</span></span><br><span class="line">            config.clusters.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">cluster</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> post_data = querystring.stringify(&#123;</span><br><span class="line">                    clusterkey: config.clusterkey,</span><br><span class="line">                    filename: req.files.uploadfile.name,</span><br><span class="line">                    filehash: d</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> post_options = &#123;</span><br><span class="line">                    hostname: cluster,</span><br><span class="line">                    port: config.clustersport,</span><br><span class="line">                    path: <span class="string">&#x27;/syncfile&#x27;</span>,</span><br><span class="line">                    method: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">                    headers: &#123;</span><br><span class="line">                        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;Content-Length&#x27;</span>: post_data.length</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Set up the request</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&#x27;syncing with &#x27;</span> + cluster);</span><br><span class="line">                <span class="keyword">var</span> post_req = http.request(post_options);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// post the data</span></span><br><span class="line">                post_req.write(post_data);</span><br><span class="line">                post_req.end();</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// return client with download path</span></span><br><span class="line">            res.send(<span class="number">200</span>, config.clusterurl + d);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/syncfile&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (req.body.clusterkey != config.clusterkey) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.send(<span class="number">401</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.sendfile(<span class="string">&#x27;files/&#x27;</span> + req.body.filehash);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// handle 404</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="number">404</span>, <span class="string">&#x27;My files gone?! :-O&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">http.createServer(app).listen(app.get(<span class="string">&#x27;port&#x27;</span>), <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;Express server listening on port &#x27;</span> + app.get(<span class="string">&#x27;port&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后是 <code>cluster.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Module dependencies.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> config = <span class="built_in">require</span>(<span class="string">&#x27;./config.js&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">&#x27;querystring&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// all environments</span></span><br><span class="line">app.set(<span class="string">&#x27;port&#x27;</span>, config.port || <span class="number">3000</span>);</span><br><span class="line">app.use(express.favicon());app.use(express.logger(<span class="string">&#x27;dev&#x27;</span>));</span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.methodOverride());</span><br><span class="line">app.use(express.bodyParser());</span><br><span class="line">app.use(app.router);</span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">&#x27;public&#x27;</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// development only</span></span><br><span class="line"><span class="keyword">if</span> (<span class="string">&#x27;development&#x27;</span> == app.get(<span class="string">&#x27;env&#x27;</span>)) &#123;</span><br><span class="line">  app.use(express.errorHandler());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="number">400</span>, <span class="string">&#x27;Bad request&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/:hash&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    fs.readFile(<span class="string">&#x27;files/&#x27;</span> + req.params.hash + <span class="string">&#x27;.json&#x27;</span>, <span class="string">&#x27;utf8&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, filedata</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="keyword">if</span> (err.code === <span class="string">&#x27;ENOENT&#x27;</span>) &#123;</span><br><span class="line">                res.send(<span class="number">404</span>, <span class="string">&#x27;File not found. :-(&#x27;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(err);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> filedata = <span class="built_in">JSON</span>.parse(filedata);</span><br><span class="line">            res.download(<span class="string">&#x27;files/&#x27;</span> + req.params.hash, filedata.filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/syncfile&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (req.body.clusterkey != config.clusterkey) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.send(<span class="number">401</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.send(<span class="number">200</span>);</span><br><span class="line">        <span class="keyword">var</span> post_data = querystring.stringify(&#123;</span><br><span class="line">            clusterkey: config.clusterkey,</span><br><span class="line">            filehash: req.body.filehash</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> post_options = &#123;</span><br><span class="line">            hostname: config.master,</span><br><span class="line">            port: config.masterport,</span><br><span class="line">            path: <span class="string">&#x27;/syncfile&#x27;</span>,</span><br><span class="line">            method: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">            headers: &#123;</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;Content-Length&#x27;</span>: post_data.length</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up the request</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;Getting file with SHA256 &#x27;</span> + req.body.filehash);</span><br><span class="line">        <span class="keyword">var</span> post_req = http.request(post_options, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> file = fs.createWriteStream(<span class="string">&#x27;files/&#x27;</span> + req.body.filehash);</span><br><span class="line">            res.pipe(file);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// post the data</span></span><br><span class="line">        post_req.write(post_data);</span><br><span class="line">        post_req.end();</span><br><span class="line"></span><br><span class="line">        fs.appendFile(<span class="string">&#x27;files/&#x27;</span> + req.body.filehash + <span class="string">&#x27;.json&#x27;</span>, <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">            <span class="string">&quot;filename&quot;</span>: req.body.filename</span><br><span class="line">        &#125;), <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&#x27;Saved file &#x27;</span> + req.body.filename + <span class="string">&#x27; with hash &#x27;</span> + req.body.filehash);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">http.createServer(app).listen(app.get(<span class="string">&#x27;port&#x27;</span>), <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;Express server listening on port &#x27;</span> + app.get(<span class="string">&#x27;port&#x27;</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这样程序应该就相当清晰了。在 cluster 端使用了SHA256值作为文件名的 json 作为文件信息存储，当前只保存了对应的文件名。至于重复文件啊什么的.. 暂时没想好怎么做，不过拿sha256做文件名本来就有这个功能的想法。本地测试完成，commit #<a target="_blank" rel="noopener" href="https://github.com/phoenixlzx/directshare/commit/f6365cfcbd18536f226da1e4fe633ece665b6ec2"><code>f6365cfcbd</code></a></p>
<p>当我发军令状的时候是昨晚9点，第一个可用版本提交是今天2点左右，5个小时开新坑再填上… 不过这坑有点小所以好填… 所以5个小时不算什么了吧就… 嘛至少不用改名BAKA了～</p>
</div></article></div></section><footer><div class="paginator"><a href="/2014/02/06/a-new-expjs-for-mypet-using-fastfibo/" class="prev">PREV</a><a href="/2014/02/02/respond-for-aaaa-queries-when-ipv4-exists-rather-than-ipv6/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'phoenixhexo';
var disqus_identifier = '2014/02/06/directshare-a-simple-file-sharing-using-direct-http-links/';
var disqus_title = 'Directshare - 一个简单的HTTP直链文件分享工具';
var disqus_url = 'https://blog.phoenixlzx.com/2014/02/06/directshare-a-simple-file-sharing-using-direct-http-links/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//phoenixhexo.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2023 <a href="https://blog.phoenixlzx.com">Phoenix Nemo</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><!--script(async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML")--><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-48847648-1",'auto');ga('send','pageview');</script></body></html>