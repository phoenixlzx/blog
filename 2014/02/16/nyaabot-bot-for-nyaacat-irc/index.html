<!DOCTYPE html><html lang="zh_CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Nyaabot: 为喵窝服务器构建的 IRC 机器人 · Phoenix's island</title><meta name="description" content="Nyaabot: 为喵窝服务器构建的 IRC 机器人 - Phoenix Nemo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/null"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.phoenixlzx.com/atom.xml" title="Phoenix's island"><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="Phoenix's island" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/static/img/avatar/avatar.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINKS</a></li><li class="nav-list-item"><a href="https://github.com/phoenixlzx" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Nyaabot: 为喵窝服务器构建的 IRC 机器人</h1><div class="post-info">2014年2月16日</div><div class="post-content"><p>第一次写 IRC 机器人。之前已经看到仙子酱等等菊苣们写了好多种 IRC 机器人，但是都是 Python 写的。倒不是歧视 Python 啊什么的… 主要是咱服务器上木有方便的环境跑，而且也有需要自己做的功能。正好在逛 NPM 的时候发现了 <a target="_blank" rel="noopener" href="https://npmjs.org/node-irc">node-irc</a> 这个包，于是折腾一下午搞出来一个机器人程序。</p>
<a id="more"></a>

<p>目前主要纠结的问题是 IRC 没有类似 HTTP Status code 或者类似的指示代码，所以我能想到的处理办法就是验证字符串。好吧我承认这种方法很不靠谱，但是… 各种求靠谱方法啊…</p>
<h3 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h3><p>专门写了一个 <code>config.js</code> 来保存客户端的配置。根据 <a target="_blank" rel="noopener" href="https://node-irc.readthedocs.org/en/latest/index.html">node-irc 的文档</a>，在程序中做如下参数设定。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">serveroptions: &#123;</span><br><span class="line">    userName: <span class="string">&#x27;nyaabot&#x27;</span>,</span><br><span class="line">    realName: <span class="string">&#x27;Nyaacat IRC Bot&#x27;</span>,</span><br><span class="line">    port: <span class="number">7000</span>,</span><br><span class="line">    debug: <span class="literal">false</span>,</span><br><span class="line">    showErrors: <span class="literal">false</span>,</span><br><span class="line">    autoRejoin: <span class="literal">true</span>,</span><br><span class="line">    autoConnect: <span class="literal">true</span>,</span><br><span class="line">    channels: [<span class="string">&#x27;#nyaacat&#x27;</span>],</span><br><span class="line">    secure: <span class="literal">true</span>,</span><br><span class="line">    selfSigned: <span class="literal">false</span>,</span><br><span class="line">    certExpired: <span class="literal">false</span>,</span><br><span class="line">    floodProtection: <span class="literal">true</span>,</span><br><span class="line">    floodProtectionDelay: <span class="number">1000</span>,</span><br><span class="line">    sasl: <span class="literal">false</span>,</span><br><span class="line">    stripColors: <span class="literal">true</span>,</span><br><span class="line">    channelPrefixes: <span class="string">&quot;&amp;#&quot;</span>,</span><br><span class="line">    messageSplit: <span class="number">512</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看起来都是很好懂的嗯。昨天在配置 CraftIRC 插件的时候撞到一个坑，NickServ 一直报错说参数不完整。调了半天发现是这里的 <code>realName</code> 部分没有填写，于是这次特地写上了注释要求该项必须填写。</p>
<h3 id="帐户验证"><a href="#帐户验证" class="headerlink" title="帐户验证"></a>帐户验证</h3><p>之后发现木有类似验证帐号的部分。查了下找到了 <a target="_blank" rel="noopener" href="https://github.com/martynsmith/node-irc/issues/205">issue #205</a>。原来验证并没有在 IRC RFC 里规定，因此没有包含在库里。嘛好吧，只好自己写了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">nyaa.addListener(<span class="string">&quot;notice&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">from, to, text, message</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// console.log(from + &#x27;\n&#x27; + to + &#x27;\n&#x27; + text + &#x27;\n&#x27; + util.inspect(message, false, null));</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">from</span> === <span class="string">&#x27;NickServ&#x27;</span></span><br><span class="line">        &amp;&amp; to === config.serveroptions.userName</span><br><span class="line">        &amp;&amp; text === <span class="string">&#x27;This nickname is registered. Please choose a different nickname, or identify via /msg NickServ identify &lt;password&gt;.&#x27;</span>) &#123;</span><br><span class="line">        nyaa.say(<span class="string">&#x27;NickServ&#x27;</span>, <span class="string">&#x27;identify &#x27;</span> + config.password);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">from</span> === <span class="string">&#x27;NickServ&#x27;</span></span><br><span class="line">        &amp;&amp; to === config.serveroptions.userName</span><br><span class="line">        &amp;&amp; text === <span class="string">&#x27;You are now identified for &#x27;</span> + config.serveroptions.userName) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;Login success.&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">from</span> === <span class="string">&#x27;NickServ&#x27;</span></span><br><span class="line">        &amp;&amp; to === config.serveroptions.userName</span><br><span class="line">        &amp;&amp; text === <span class="string">&#x27;Invalid password for &#x27;</span> + config.serveroptions.userName) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;Incorrect password. check you config!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>嗯现在就是验证字符串… 所以似乎只能在 freenode 上跑，其他 IRC 服务器是不是这样就不知道了。测试了下表示没问题，收到登陆成功的提示了。</p>
<h3 id="消息处理"><a href="#消息处理" class="headerlink" title="消息处理"></a>消息处理</h3><p>目前不准备做私信支持，所以在收到 pm 的时候直接丢一句话过去就可以了。顺便，可以做成自定义消息的说，于是加上了 <code>messages.js</code> 包含所有的可自定义消息。</p>
<p>然后是最重要的功能之一——命令。没命令的 bot 不是好 bot 嗯。编写程序时候的想法是命令以特定字符开头，但是后面如何验证，用 Stackoverflow 上扒来的 <code>startsWith</code> 和 <code>endsWith</code> 函数似乎不能做到足够准确，所以暂且用一个字母加参数来作为命令好了。首先想到的命令功能是搜索 Wiki。毕竟 Minecraft 游戏有够复杂即便是老玩家也不一定能记住 Wiki 里的所有内容。这里想要实现的效果是，提交关键字，返回搜索到的页面链接，并发送该页面的内容总结——也就是 Mediawiki 页面的 section 0。</p>
<p>这里用到了 <code>request</code> 模块，因为 <code>http.get</code> 被弃用且 <code>http.request</code> 说实话用起来比较不爽。<code>request</code> 可以轻松得到页面内容。根据 <a target="_blank" rel="noopener" href="http://en.wikipedia.org/w/api.php">Mediawiki API</a> 确定使用如下2个请求参数：</p>
<ul>
<li><code>/api.php?action=query&amp;format=xml&amp;titles=[页面标题]</code></li>
<li><code>/api.php?format=json&amp;action=parse&amp;prop=text&amp;section=0&amp;page=[页面标题]</code></li>
</ul>
<p>话说我倒是想都用 JSON 的，毕竟 Javascript 原生支持的东西。但是但是第一个 API 返回的 JSON 居然把页面的 pageid 作为 key 啦！你这要我如何是好，为了拿你一个 key/value 要麻烦死了哦。所以还是选择了 XML 并且使用了 <a target="_blank" rel="noopener" href="https://github.com/Leonidas-from-XIV/node-xml2js">xml2js</a> 这个库。</p>
<p>第二个 API 的数据处理其实一开始也是用的 XML，因为返回的 JSON 里一个 key 是 <code>*</code>，然后我就 <del>很丢脸的</del> 不知所错了… 问了仙子才知道这种带有特殊符号的使用方法是…</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;v&quot;</span>: &#123;</span><br><span class="line">	      <span class="string">&quot;*&quot;</span>:&#123;</span><br><span class="line">			<span class="string">&quot;key1&quot;</span>: <span class="string">&quot;value1&quot;</span>,</span><br><span class="line">			<span class="string">&quot;key2&quot;</span>: <span class="string">&quot;value2&quot;</span></span><br><span class="line">		  &#125;</span><br><span class="line">	  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样的拿到 <code>*</code> 的属性值的方法是 <code>v[&#39;*&#39;]</code> ……… <del>基本功不扎实，实在是太丢脸了 &gt;////&lt;</del></p>
<p>于是拿到了返回文章 summary 的 HTML 代码。先是用正则去掉所有的 HTML Tag 和 <code>\n \r</code> 等换行符，然后发现 HTML 实体没有被转换，于是偷懒用了 <a target="_blank" rel="noopener" href="https://www.npmjs.org/package/htmlstrip-native">htmlstrip-native</a> 来搞定这个问题。</p>
<p>测试后发现可以正确返回得到页面的链接，但是总结发出来却是乱码。感觉应该是包含了无效的 UTF-8 编码，遂尝试使用正则 <code>/\uFFFD/g</code> 替换掉无效的编码但是不起作用。试图移除最后一个字符也是无用。折腾了大约有2个小时，突然发现如果不去掉换行符则消息发出来是正常的。但是不去掉的话一行只有几个字啊… </p>
<p>不过还是有收获，仙子根据不移除换行符则消息正常判断是 IRC 消息长度限制导致了 UTF-8 流被截断。RFC 规定 IRC 消息长度为512，但是一个 CJK 字符通常占3位。所以 512/3 差不多是170。嘛很不爽的把消息限制改成了144。这样发出来就不乱码了，但是总结大多比较长要连续发好几条消息导致游戏端被刷屏，玩家颇有微词。</p>
<p>后面就方便多了，加了一条 <code>&#39;p&#39;</code> 命令，意为 <code>play</code> 即 <del>玩坏</del>。在 <code>messages.js</code> 里设定了一个 Object 包含2个数组，对应命令消息和响应消息。程序中用 <code>async</code> 来实现命令匹配和回复，以及在没有找到可用命令时发送命令未知消息。还有一条 <code>&#39;c&#39;</code> 用来执行一些真正的命令——比如退出 <em>(:з」∠)</em></p>
<p>嘛现在这 <a target="_blank" rel="noopener" href="https://github.com/phoenixlzx/nyaabot">bot</a> 已经在群里开始调(wan)戏(huai)二小姐了233</p>
</div></article></div></section><footer><div class="paginator"><a href="/2014/02/17/file-upload-with-expressjs-and-formidable/" class="prev">上一篇</a><a href="/2014/02/11/a-simple-wordpress-backup-script/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'phoenixhexo';
var disqus_identifier = '2014/02/16/nyaabot-bot-for-nyaacat-irc/';
var disqus_title = 'Nyaabot: 为喵窝服务器构建的 IRC 机器人';
var disqus_url = 'https://blog.phoenixlzx.com/2014/02/16/nyaabot-bot-for-nyaacat-irc/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//phoenixhexo.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2021 <a href="https://blog.phoenixlzx.com">Phoenix Nemo</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><!--script(async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML")--><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-48847648-1",'auto');ga('send','pageview');</script></body></html>