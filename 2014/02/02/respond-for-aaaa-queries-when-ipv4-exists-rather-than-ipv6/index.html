<!DOCTYPE html><html lang="zh_CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> IPv4 存在而 IPv6 不存在时对于 AAAA 记录查询的响应 · Phoenix's island</title><meta name="description" content="IPv4 存在而 IPv6 不存在时对于 AAAA 记录查询的响应 - Phoenix Nemo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/null"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.phoenixlzx.com/atom.xml" title="Phoenix's island"><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="Phoenix's island" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/static/img/avatar/avatar.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINKS</a></li><li class="nav-list-item"><a href="https://github.com/phoenixlzx" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">IPv4 存在而 IPv6 不存在时对于 AAAA 记录查询的响应</h1><div class="post-info">2014年2月2日</div><div class="post-content"><p>昨天收到了仙子酱 forward 给我的来自 prosody 开发者的回复，关于 Google 无法连接到 <code>talk.archlinuxcn.org</code> 的问题。开发者指出是 DNS 响应不规范，在 IPv4 存在而 IPv6 不存在时，如果首先查询 <code>AAAA</code> 记录而得到了 <code>NXDOMAIN</code>，则会停止继续查询记录。</p>
<a id="more"></a>

<p>根据 <a target="_blank" rel="noopener" href="http://www.ietf.org/rfc/rfc4074.txt">RFC 4074</a>，在 IPv4 存在而 IPv6 不存在时，对于 <code>AAAA</code> 记录的响应 RCODE 应为<code>0</code>，即 <code>NOERROR</code> 而不是 <code>NXDOMAIN</code>。</p>
<p>根据RFC的说明对略萌DNS的程序做了部分修改，commit #<a target="_blank" rel="noopener" href="https://github.com/phoenixlzx/minimoedns/commit/a5a81172d5b4ab0fee375a70b7065883ff0fbc97"><code>a5a81172d5</code></a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">connection.query(<span class="string">&#x27;SELECT * from `records` WHERE `paused` IS NOT TRUE AND `name` = ? AND (`type` = &quot;A&quot; OR `type` = &quot;AAAA&quot; OR `type` = &quot;CNAME&quot;)&#x27;</span>,</span><br><span class="line">    name,</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123; </span><br><span class="line">	  ...</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">result.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">record</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (record.type) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;A&quot;</span>: </span><br><span class="line">	<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&quot;AAAA&quot;</span>:</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>

<p>一个简单的改动，没做什么测试就提交了。然后发现 Google DNS 等缓存DNS给<code>AAAA</code>查询返回了<code>SERVFAIL</code>…</p>
<p><code>dig +trace</code> 查了下发现死循环了… 再去看 RFC 同时用猫的 NS 服务器做了测试，发现对于这种情况，返回的记录是 Authority 部分 SOA，其他全部是空，格式和 <code>NXDOMAIN</code> 一样，只不过RCODE是 <code>NOERROR</code> 而已。</p>
<p>嘛。commit #<a target="_blank" rel="noopener" href="https://github.com/phoenixlzx/minimoedns/commit/5f50bbaa89ac7b51259aeaaa54b08d65476300da"><code>5f50bbaa89</code></a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;A&quot;</span>:</span><br><span class="line">    <span class="keyword">var</span> content = SOAresult[<span class="number">0</span>].content.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    response.authority.push(dns.SOA(&#123;</span><br><span class="line">	name: SOAresult[<span class="number">0</span>].name,</span><br><span class="line">	primary: content[<span class="number">0</span>],</span><br><span class="line">	admin: content[<span class="number">1</span>].replace(<span class="string">&quot;@&quot;</span>, <span class="string">&quot;.&quot;</span>),</span><br><span class="line">	serial: content[<span class="number">2</span>],</span><br><span class="line">	refresh: content[<span class="number">3</span>],</span><br><span class="line">	retry: content[<span class="number">4</span>],</span><br><span class="line">	expiration: content[<span class="number">5</span>],</span><br><span class="line">	minimum: content[<span class="number">6</span>],</span><br><span class="line">	ttl: SOAresult[<span class="number">0</span>].ttl||config.defaultTTL</span><br><span class="line">    &#125;));</span><br><span class="line">    response.header.rcode = consts.NAME_TO_RCODE.NOERROR;</span><br><span class="line">    <span class="keyword">return</span> response.send();</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>然后发现把 <code>case &quot;A&quot;</code> 写到前面不对… 然后把这段改到了 <code>case &quot;AAAA&quot;</code> 和 <code>case &quot;CNAME&quot;</code> 后面，另外在 MySQL 模块中也做了修改，防止在有 IPv6 时返回 IPv4。咱基本不会写 SQL 于是做了两步查询。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.queryAAAA = <span class="function"><span class="keyword">function</span>(<span class="params">name, callback</span>) </span>&#123;</span><br><span class="line">    pool.getConnection(<span class="function"><span class="keyword">function</span>(<span class="params">err, connection</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(err.message);</span><br><span class="line">        &#125;</span><br><span class="line">        connection.query(<span class="string">&#x27;SELECT * from `records` WHERE `paused` IS NOT TRUE AND `name` = ? AND (`type` = &quot;AAAA&quot; OR `type` = &quot;CNAME&quot;)&#x27;</span>,</span><br><span class="line">            name,</span><br><span class="line">            <span class="function"><span class="keyword">function</span>(<span class="params">err, result</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    connection.release();</span><br><span class="line">                    <span class="keyword">return</span> callback(err, <span class="literal">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (result[<span class="number">0</span>]) &#123;</span><br><span class="line">                    connection.release();</span><br><span class="line">                    callback(<span class="literal">null</span>, result);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    connection.query(<span class="string">&#x27;SELECT * from `records` WHERE `paused` IS NOT TRUE AND `name` = ? AND `type` = &quot;A&quot;&#x27;</span>,</span><br><span class="line">                        name,</span><br><span class="line">                        <span class="function"><span class="keyword">function</span>(<span class="params">err, resultA</span>) </span>&#123;</span><br><span class="line">                            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                                connection.release();</span><br><span class="line">                                <span class="keyword">return</span> callback(err, <span class="literal">null</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            connection.release();</span><br><span class="line">                            callback(<span class="literal">null</span>, resultA);</span><br><span class="line">                        &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看起来处理的有点 ugly 不过咱才疏学浅只好先这样了。 commit 之后所有略萌DNS节点更新，于是再次查询就正常了w</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">~&gt;</span> <span class="string">dig</span> <span class="string">@8.8.8.8</span> <span class="string">talk.archlinuxcn.org</span> <span class="string">AAAA</span></span><br><span class="line"></span><br><span class="line"><span class="string">;</span> <span class="string">&lt;&lt;&gt;&gt;</span> <span class="string">DiG</span> <span class="number">9.9</span><span class="number">.2</span><span class="string">-P2</span> <span class="string">&lt;&lt;&gt;&gt;</span> <span class="string">@8.8.8.8</span> <span class="string">talk.archlinuxcn.org</span> <span class="string">AAAA</span></span><br><span class="line"><span class="string">;</span> <span class="string">(1</span> <span class="string">server</span> <span class="string">found)</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">global options:</span> <span class="string">+cmd</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">Got answer:</span></span><br><span class="line"><span class="string">;;</span> <span class="string">-&gt;&gt;HEADER&lt;&lt;-</span> <span class="attr">opcode:</span> <span class="string">QUERY,</span> <span class="attr">status:</span> <span class="string">NOERROR,</span> <span class="attr">id:</span> <span class="number">26181</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">flags:</span> <span class="string">qr</span> <span class="string">rd</span> <span class="string">ra;</span> <span class="attr">QUERY:</span> <span class="number">1</span><span class="string">,</span> <span class="attr">ANSWER:</span> <span class="number">0</span><span class="string">,</span> <span class="attr">AUTHORITY:</span> <span class="number">1</span><span class="string">,</span> <span class="attr">ADDITIONAL:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="string">;;</span> <span class="attr">OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">;</span> <span class="attr">EDNS: version:</span> <span class="number">0</span><span class="string">,</span> <span class="string">flags:;</span> <span class="attr">udp:</span> <span class="number">512</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">QUESTION SECTION:</span></span><br><span class="line"><span class="string">;talk.archlinuxcn.org.</span>          <span class="string">IN</span>      <span class="string">AAAA</span></span><br><span class="line"></span><br><span class="line"><span class="string">;;</span> <span class="attr">AUTHORITY SECTION:</span></span><br><span class="line"><span class="string">archlinuxcn.org.</span>        <span class="number">1800    </span><span class="string">IN</span>      <span class="string">SOA</span>     <span class="string">ns1.moedns.net.</span> <span class="string">admin.moedns.com.</span> <span class="number">1391266676</span> <span class="number">3600 </span><span class="number">360</span> <span class="number">1209600</span> <span class="number">180</span></span><br><span class="line"></span><br><span class="line"><span class="string">;;</span> <span class="attr">Query time:</span> <span class="number">224</span> <span class="string">msec</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">SERVER:</span> <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span><span class="comment">#53(8.8.8.8)</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">WHEN:</span> <span class="string">Sun</span> <span class="string">Feb</span>  <span class="number">2</span> <span class="number">12</span><span class="string">:23:18</span> <span class="number">2014</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">MSG SIZE  rcvd:</span> <span class="number">115</span></span><br></pre></td></tr></table></figure>
</div></article></div></section><footer><div class="paginator"><a href="/2014/02/06/directshare-a-simple-file-sharing-using-direct-http-links/" class="prev">PREV</a><a href="/2014/02/01/simple-steps-with-ubuntu-server/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'phoenixhexo';
var disqus_identifier = '2014/02/02/respond-for-aaaa-queries-when-ipv4-exists-rather-than-ipv6/';
var disqus_title = 'IPv4 存在而 IPv6 不存在时对于 AAAA 记录查询的响应';
var disqus_url = 'https://blog.phoenixlzx.com/2014/02/02/respond-for-aaaa-queries-when-ipv4-exists-rather-than-ipv6/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//phoenixhexo.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2020 <a href="https://blog.phoenixlzx.com">Phoenix Nemo</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><!--script(async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML")--><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-48847648-1",'auto');ga('send','pageview');</script></body></html>