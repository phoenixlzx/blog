<!DOCTYPE html><html lang="zh_CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 玩了一下 NGINX RealIP 模块 · Phoenix's island</title><meta name="description" content="玩了一下 NGINX RealIP 模块 - Phoenix Nemo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/null"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.phoenixlzx.com/atom.xml" title="Phoenix's island"><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="Phoenix's island" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/static/img/avatar/avatar.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINKS</a></li><li class="nav-list-item"><a href="https://github.com/phoenixlzx" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">玩了一下 NGINX RealIP 模块</h1><div class="post-info">2017年2月8日</div><div class="post-content"><p>最近要给网站上 CDN 于是折腾了下在 NGINX 部分获取客户端真实 IP 的方案。</p>
<p>嘛… 意想不到的简单就是…</p>
<a id="more"></a>

<h2 id="安装-realip-模块"><a href="#安装-realip-模块" class="headerlink" title="安装 realip 模块"></a>安装 realip 模块</h2><p>如果是 Debian/Ubuntu 系统，直接安装 <code>nginx-extras</code> 这个包即可。包含了很多有用的模块，不需要再自己编译。</p>
<p>如果是其他发行版，且没有提供额外模块的包的话，需要自己编译 NGINX。编译参数加 <code>--with-http_realip_module</code> 即可。</p>
<h2 id="获得前端服务器地址"><a href="#获得前端服务器地址" class="headerlink" title="获得前端服务器地址"></a>获得前端服务器地址</h2><p>常见的 CDN 前端 IP 都可以从 CDN 提供商处获得，例如 CloudFlare 的 IP 地址段在<a target="_blank" rel="noopener" href="https://www.cloudflare.com/ips/">这里</a>。</p>
<p>如果需要找到 Google Cloud Platform 的 IP 地址段，可以使用 <a target="_blank" rel="noopener" href="https://groups.google.com/forum/#!topic/gce-discussion/V2n9Ri-T5qg">Google 提供的 TXT 记录</a>查询。</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ dig @<span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span> _cloud-netblocks.googleusercontent.com TXT</span><br></pre></td></tr></table></figure>

<p>获得记录</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">;</span> <span class="string">&lt;&lt;&gt;&gt;</span> <span class="string">DiG</span> <span class="number">9.11</span><span class="number">.0</span><span class="string">-P2</span> <span class="string">&lt;&lt;&gt;&gt;</span> <span class="string">@8.8.8.8</span> <span class="string">_cloud-netblocks.googleusercontent.com</span> <span class="string">TXT</span></span><br><span class="line"><span class="string">;</span> <span class="string">(1</span> <span class="string">server</span> <span class="string">found)</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">global options:</span> <span class="string">+cmd</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">Got answer:</span></span><br><span class="line"><span class="string">;;</span> <span class="string">-&gt;&gt;HEADER&lt;&lt;-</span> <span class="attr">opcode:</span> <span class="string">QUERY,</span> <span class="attr">status:</span> <span class="string">NOERROR,</span> <span class="attr">id:</span> <span class="number">42732</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">flags:</span> <span class="string">qr</span> <span class="string">rd</span> <span class="string">ra;</span> <span class="attr">QUERY:</span> <span class="number">1</span><span class="string">,</span> <span class="attr">ANSWER:</span> <span class="number">1</span><span class="string">,</span> <span class="attr">AUTHORITY:</span> <span class="number">0</span><span class="string">,</span> <span class="attr">ADDITIONAL:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="string">;;</span> <span class="attr">OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">;</span> <span class="attr">EDNS: version:</span> <span class="number">0</span><span class="string">,</span> <span class="string">flags:;</span> <span class="attr">udp:</span> <span class="number">512</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">QUESTION SECTION:</span></span><br><span class="line"><span class="string">;_cloud-netblocks.googleusercontent.com.</span>        <span class="string">IN</span> <span class="string">TXT</span></span><br><span class="line"></span><br><span class="line"><span class="string">;;</span> <span class="attr">ANSWER SECTION:</span></span><br><span class="line"><span class="string">_cloud-netblocks.googleusercontent.com.</span> <span class="number">3599 </span><span class="string">IN</span> <span class="string">TXT</span> <span class="string">&quot;v=spf1 include:_cloud-netblocks1.googleusercontent.com include:_cloud-netblocks2.googleusercontent.com include:_cloud-netblocks3.googleusercontent.com include:_cloud-netblocks4.googleusercontent.com include:_cloud-netblocks5.googleusercontent.com ?all&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">;;</span> <span class="attr">Query time:</span> <span class="number">51</span> <span class="string">msec</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">SERVER:</span> <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span><span class="comment">#53(8.8.8.8)</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">WHEN:</span> <span class="string">Wed</span> <span class="string">Feb</span> <span class="number">08</span> <span class="number">20</span><span class="string">:31:29</span> <span class="string">JST</span> <span class="number">2017</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">MSG SIZE  rcvd:</span> <span class="number">331</span></span><br></pre></td></tr></table></figure>

<p>这里面的 <code>_cloud-netblocks1.googleusercontent.com</code> 等地址即是用于保存 GCP IP 段的地址。继续查询：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig @<span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span> _cloud-netblocks1.googleusercontent.com TXT</span><br></pre></td></tr></table></figure>

<p>获得记录</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">;</span> <span class="string">&lt;&lt;&gt;&gt;</span> <span class="string">DiG</span> <span class="number">9.11</span><span class="number">.0</span><span class="string">-P2</span> <span class="string">&lt;&lt;&gt;&gt;</span> <span class="string">@8.8.8.8</span> <span class="string">_cloud-netblocks1.googleusercontent.com</span> <span class="string">TXT</span></span><br><span class="line"><span class="string">;</span> <span class="string">(1</span> <span class="string">server</span> <span class="string">found)</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">global options:</span> <span class="string">+cmd</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">Got answer:</span></span><br><span class="line"><span class="string">;;</span> <span class="string">-&gt;&gt;HEADER&lt;&lt;-</span> <span class="attr">opcode:</span> <span class="string">QUERY,</span> <span class="attr">status:</span> <span class="string">NOERROR,</span> <span class="attr">id:</span> <span class="number">22867</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">flags:</span> <span class="string">qr</span> <span class="string">rd</span> <span class="string">ra;</span> <span class="attr">QUERY:</span> <span class="number">1</span><span class="string">,</span> <span class="attr">ANSWER:</span> <span class="number">1</span><span class="string">,</span> <span class="attr">AUTHORITY:</span> <span class="number">0</span><span class="string">,</span> <span class="attr">ADDITIONAL:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="string">;;</span> <span class="attr">OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">;</span> <span class="attr">EDNS: version:</span> <span class="number">0</span><span class="string">,</span> <span class="string">flags:;</span> <span class="attr">udp:</span> <span class="number">512</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">QUESTION SECTION:</span></span><br><span class="line"><span class="string">;_cloud-netblocks1.googleusercontent.com.</span> <span class="string">IN</span> <span class="string">TXT</span></span><br><span class="line"></span><br><span class="line"><span class="string">;;</span> <span class="attr">ANSWER SECTION:</span></span><br><span class="line"><span class="string">_cloud-netblocks1.googleusercontent.com.</span> <span class="number">3599 </span><span class="string">IN</span> <span class="string">TXT</span> <span class="string">&quot;v=spf1 ip4:8.34.208.0/20 ip4:8.35.192.0/21 ip4:8.35.200.0/23 ip4:108.59.80.0/20 ip4:108.170.192.0/20 ip4:108.170.208.0/21 ip4:108.170.216.0/22 ip4:108.170.220.0/23 ip4:108.170.222.0/24 ?all&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">;;</span> <span class="attr">Query time:</span> <span class="number">55</span> <span class="string">msec</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">SERVER:</span> <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span><span class="comment">#53(8.8.8.8)</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">WHEN:</span> <span class="string">Wed</span> <span class="string">Feb</span> <span class="number">08</span> <span class="number">20</span><span class="string">:32:39</span> <span class="string">JST</span> <span class="number">2017</span></span><br><span class="line"><span class="string">;;</span> <span class="attr">MSG SIZE  rcvd:</span> <span class="number">270</span></span><br></pre></td></tr></table></figure>

<p>于是得到了一堆 IP 地址。</p>
<h2 id="设置-RealIP-模块"><a href="#设置-RealIP-模块" class="headerlink" title="设置 RealIP 模块"></a>设置 RealIP 模块</h2><p>文件 <code>/etc/nginx/snippets/realip.conf</code>，请注意这个位置在其他发行版未必存在，放在 NGINX 配置目录下即可。</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set_real_ip_from  <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span>;</span><br><span class="line">set_real_ip_from  <span class="number">192.168</span><span class="number">.2</span><span class="number">.1</span>;</span><br><span class="line">set_real_ip_from  <span class="number">2001</span>:<span class="number">0</span>db8::/<span class="number">32</span>;</span><br><span class="line">real_ip_header    X-Forwarded-For;</span><br></pre></td></tr></table></figure>

<p>然后在 vhost 配置文件中引用这个配置。</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="meta-keyword">include</span> snippets/realip.conf;</span></span><br></pre></td></tr></table></figure>

<p>搞定，重启 NGINX 即可获得客户端真实 IP。</p>
<p>Note:</p>
<p>GCP 的 <code>X-Forwarded-For</code> 的客户端 IP 在第一个 <code>,</code> 的前面，所以一般需要 <code>split(&#39;,&#39;)[0]</code>。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2017/02/18/dont-ask-me-why-invent-another-planet-river-of-news/" class="prev">PREV</a><a href="/2016/12/12/infinite-zheteng-switch-to-gcp/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'phoenixhexo';
var disqus_identifier = '2017/02/08/play-with-nginx-realip-module/';
var disqus_title = '玩了一下 NGINX RealIP 模块';
var disqus_url = 'https://blog.phoenixlzx.com/2017/02/08/play-with-nginx-realip-module/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//phoenixhexo.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2022 <a href="https://blog.phoenixlzx.com">Phoenix Nemo</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><!--script(async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML")--><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-48847648-1",'auto');ga('send','pageview');</script></body></html>