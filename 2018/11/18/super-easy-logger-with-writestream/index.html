<!DOCTYPE html><html lang="zh_CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 使用 fs.WriteStream 编写超简单的日志流 · Phoenix's island</title><meta name="description" content="使用 fs.WriteStream 编写超简单的日志流 - Phoenix Nemo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/null"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.phoenixlzx.com/atom.xml" title="Phoenix's island"><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="Phoenix's island" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/static/img/avatar/avatar.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINKS</a></li><li class="nav-list-item"><a href="https://github.com/phoenixlzx" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">使用 fs.WriteStream 编写超简单的日志流</h1><div class="post-info">2018年11月18日</div><div class="post-content"><p>虽然 <code>console.log</code> 很好用，但是生产环境需要保存日志的时候就比较蛋疼。暴力 <code>fs.appendFile</code> 会消耗大量的 file handler，因此用 writable stream 来复用 file handler 是更好的选择。</p>
<a id="more"></a>

<p>大概是个不能再简单的思路了。先创建一个写入流</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> logStream = fs.createWriteStream(<span class="string">&#x27;./test.log&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>这样便创建了一个文件写入口，需要时直接调用 <code>logStream.write</code> 即可写入数据。<br>接下来编写一个用于记录日志的函数替代 <code>console.log</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logger</span> <span class="params">(message)</span></span> &#123;</span><br><span class="line">    logStream.<span class="built_in">write</span>(message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此基本功能就写完啦。但是太简陋了对不对，还是要再加点装饰。</p>
<p>重写 <code>logger</code> 函数，区分 <code>stdout</code> 和 <code>stderr</code></p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> logInfo = fs.create<span class="constructor">WriteStream(&#x27;.<span class="operator">/</span><span class="params">stdout</span>.<span class="params">log</span>&#x27;)</span>;</span><br><span class="line"><span class="keyword">let</span> logError = fs.create<span class="constructor">WriteStream(&#x27;.<span class="operator">/</span><span class="params">stderr</span>.<span class="params">log</span>&#x27;)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> Logger = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">Logger</span>.</span></span>info =<span class="function"> (<span class="params">message</span>) =&gt;</span> &#123;</span><br><span class="line">    logInfo.write(&#x27;<span class="literal">[INFO]</span> &#x27; + message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">Logger</span>.</span></span>error =<span class="function"> (<span class="params">message</span>) =&gt;</span> &#123;</span><br><span class="line">    logError.write(&#x27;<span class="literal">[ERROR]</span> &#x27; + message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>感觉还是少了点什么…日期？</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Logger.info = <span class="function"><span class="params">(message)</span> =&gt;</span> &#123;</span><br><span class="line">    logInfo.write(<span class="keyword">new</span> <span class="built_in">Date</span>().toISOString() + <span class="string">&#x27; [INFO] &#x27;</span> + message + <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>嗯嗯。这就像样了。把代码整合起来</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">const fs = require(&#x27;fs&#x27;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> logInfo = fs.create<span class="constructor">WriteStream(&#x27;.<span class="operator">/</span><span class="params">stdout</span>.<span class="params">log</span>&#x27;)</span>;</span><br><span class="line"><span class="keyword">let</span> logError = fs.create<span class="constructor">WriteStream(&#x27;.<span class="operator">/</span><span class="params">stderr</span>.<span class="params">log</span>&#x27;)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> Logger = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">Logger</span>.</span></span>info =<span class="function"> (<span class="params">message</span>) =&gt;</span> &#123;</span><br><span class="line">    logInfo.write(<span class="keyword">new</span> <span class="constructor">Date()</span>.<span class="keyword">to</span><span class="constructor">ISOString()</span> + &#x27; <span class="literal">[INFO]</span> &#x27; + message + <span class="character">&#x27;\n&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">Logger</span>.</span></span>error =<span class="function"> (<span class="params">message</span>) =&gt;</span> &#123;</span><br><span class="line">    logError.write(<span class="keyword">new</span> <span class="constructor">Date()</span>.<span class="keyword">to</span><span class="constructor">ISOString()</span> + &#x27; <span class="literal">[ERROR]</span> &#x27; + message + <span class="character">&#x27;\n&#x27;</span>);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span>.exports = Logger;</span><br></pre></td></tr></table></figure>

<p>需要用时</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Logger.<span class="builtin-name">info</span>(<span class="string">&#x27;This is an information.&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>现在看对应的 <code>stdout.log</code> 文件就有相应内容啦。</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~&gt; tail -f stdout.log</span><br><span class="line"><span class="number">2018</span><span class="number">-11</span><span class="number">-18</span>T10:<span class="number">52</span>:<span class="number">57.333</span>Z [INFO] This <span class="keyword">is</span> an information.</span><br></pre></td></tr></table></figure>

<p>不够刺激？</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[...<span class="built_in">Array</span>(<span class="number">10000</span>)].forEach(<span class="function"><span class="params">(item, index)</span> =&gt;</span> &#123;</span><br><span class="line">    Logger.info(<span class="string">&#x27;Hello! &#x27;</span> + index);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~&gt; tail -f stdout.log</span><br><span class="line">...</span><br><span class="line"><span class="number">2018</span><span class="number">-11</span><span class="number">-18</span>T10:<span class="number">58</span>:<span class="number">30.661</span>Z [INFO] Hello! <span class="number">9990</span></span><br><span class="line"><span class="number">2018</span><span class="number">-11</span><span class="number">-18</span>T10:<span class="number">58</span>:<span class="number">30.661</span>Z [INFO] Hello! <span class="number">9991</span></span><br><span class="line"><span class="number">2018</span><span class="number">-11</span><span class="number">-18</span>T10:<span class="number">58</span>:<span class="number">30.661</span>Z [INFO] Hello! <span class="number">9992</span></span><br><span class="line"><span class="number">2018</span><span class="number">-11</span><span class="number">-18</span>T10:<span class="number">58</span>:<span class="number">30.661</span>Z [INFO] Hello! <span class="number">9993</span></span><br><span class="line"><span class="number">2018</span><span class="number">-11</span><span class="number">-18</span>T10:<span class="number">58</span>:<span class="number">30.661</span>Z [INFO] Hello! <span class="number">9994</span></span><br><span class="line"><span class="number">2018</span><span class="number">-11</span><span class="number">-18</span>T10:<span class="number">58</span>:<span class="number">30.661</span>Z [INFO] Hello! <span class="number">9995</span></span><br><span class="line"><span class="number">2018</span><span class="number">-11</span><span class="number">-18</span>T10:<span class="number">58</span>:<span class="number">30.661</span>Z [INFO] Hello! <span class="number">9996</span></span><br><span class="line"><span class="number">2018</span><span class="number">-11</span><span class="number">-18</span>T10:<span class="number">58</span>:<span class="number">30.661</span>Z [INFO] Hello! <span class="number">9997</span></span><br><span class="line"><span class="number">2018</span><span class="number">-11</span><span class="number">-18</span>T10:<span class="number">58</span>:<span class="number">30.661</span>Z [INFO] Hello! <span class="number">9998</span></span><br><span class="line"><span class="number">2018</span><span class="number">-11</span><span class="number">-18</span>T10:<span class="number">58</span>:<span class="number">30.661</span>Z [INFO] Hello! <span class="number">9999</span></span><br></pre></td></tr></table></figure>

<p>搞定(┌・ω・)┌超简单的吧。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2018/12/14/bootable-archlinux-in-memory-rescue-system/" class="prev">PREV</a><a href="/2018/09/28/stickerset2packbot-refactory-with-telegraf/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'phoenixhexo';
var disqus_identifier = '2018/11/18/super-easy-logger-with-writestream/';
var disqus_title = '使用 fs.WriteStream 编写超简单的日志流';
var disqus_url = 'https://blog.phoenixlzx.com/2018/11/18/super-easy-logger-with-writestream/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//phoenixhexo.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2023 <a href="https://blog.phoenixlzx.com">Phoenix Nemo</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><!--script(async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML")--><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-48847648-1",'auto');ga('send','pageview');</script></body></html>