<!DOCTYPE html><html lang="zh_CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 在 Linux 服务器配置 LACP 与 VLAN · Phoenix's island</title><meta name="description" content="在 Linux 服务器配置 LACP 与 VLAN - Phoenix Nemo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/null"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.phoenixlzx.com/atom.xml" title="Phoenix's island"><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="Phoenix's island" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/static/img/avatar/avatar.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINKS</a></li><li class="nav-list-item"><a href="https://github.com/phoenixlzx" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">在 Linux 服务器配置 LACP 与 VLAN</h1><div class="post-info">2018年4月18日</div><div class="post-content"><p>存储服务器不想放在 OVH 了。所以自己来托管一台机器，顺便折腾下 2x1Gbps 组 LACP Bonding。</p>
<a id="more"></a>

<p>前提：服务器需要至少 2 个千兆物理网卡，上联交换机支持 802.3ad。</p>
<h3 id="配置交换机"><a href="#配置交换机" class="headerlink" title="配置交换机"></a>配置交换机</h3><p>这里使用的是 Cisco Nexus 3064PQ-10GE 交换机，我们的接口在 <code>Eth1/21-22</code>，port-channel 的配置如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># show interface trunk</span></span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Port          Native  Status        Port</span><br><span class="line">             <span class="built_in"> Vlan </span>                 Channel</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Eth1/21       1       trnk-bndl     Po100</span><br><span class="line">Eth1/22       1       trnk-bndl     Po100</span><br><span class="line">Po100         1       trunking      --</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">show port-channel database</span><br><span class="line">port-channel100</span><br><span class="line">    Last membership update <span class="keyword">is</span> successful</span><br><span class="line">    <span class="number">2</span> ports <span class="keyword">in</span> total, <span class="number">2</span> ports up</span><br><span class="line">    First operational port <span class="keyword">is</span> Ethernet1/<span class="number">21</span></span><br><span class="line">    Age of the port-channel <span class="keyword">is</span> <span class="number">0</span>d:<span class="number">00</span>h:<span class="number">02</span>m:<span class="number">16</span>s</span><br><span class="line">    Time since last bundle <span class="keyword">is</span> <span class="number">0</span>d:<span class="number">00</span>h:<span class="number">02</span>m:<span class="number">04</span>s</span><br><span class="line">    Last bundled member <span class="keyword">is</span> Ethernet1/<span class="number">22</span></span><br><span class="line">    Ports:   Ethernet1/<span class="number">21</span>    [active ] [up] *</span><br><span class="line">             Ethernet1/<span class="number">22</span>    [active ] [up]</span><br></pre></td></tr></table></figure>

<h3 id="配置服务器"><a href="#配置服务器" class="headerlink" title="配置服务器"></a>配置服务器</h3><p>服务器操作系统是 Arch Linux，由于蜜汁问题 netctl 无法启动网卡，就只好用 systemd-networkd 啦。</p>
<p>麻烦一些，但是也还算顺利。与往常一样，折腾服务器网络的时候需要备着 IPMI 以防 connection lost。</p>
<h5 id="内核模块"><a href="#内核模块" class="headerlink" title="内核模块"></a>内核模块</h5><p>需要加载 <code>bonding</code> 模块。将模块名写入列表，文件 <code>/etc/modules-load.d/bonding.conf</code>，内容只需要一行：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">bonding</span></span><br></pre></td></tr></table></figure>

<p>先别急着加载模块，为了防止模块自动建立一个默认网卡影响后续配置，以及设置 LACP Mode=4 … 等等，先加入一行参数。文件 <code>/etc/modprobe.d/bonding.conf</code></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">options bonding <span class="attribute">mode</span>=4 <span class="attribute">miimon</span>=100 <span class="attribute">max_bonds</span>=0</span><br></pre></td></tr></table></figure>

<p>然后安装 <code>ifenslave</code> 包，再 <code>modprobe bonding</code> 即可。</p>
<h5 id="bonding-虚拟网卡"><a href="#bonding-虚拟网卡" class="headerlink" title="bonding 虚拟网卡"></a>bonding 虚拟网卡</h5><p>首先创建一个虚拟网卡的设备。文件 <code>/etc/systemd/network/bond0.netdev</code> 内容为</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[NetDev]</span></span><br><span class="line"><span class="attr">Name</span>=bond0</span><br><span class="line"><span class="attr">Kind</span>=bond</span><br><span class="line"></span><br><span class="line"><span class="section">[Bond]</span></span><br><span class="line"><span class="attr">Mode</span>=<span class="number">802.3</span>ad</span><br><span class="line"><span class="attr">TransmitHashPolicy</span>=layer2+<span class="number">3</span></span><br><span class="line"><span class="attr">LACPTransmitRate</span>=fast</span><br><span class="line"><span class="attr">AdSelect</span>=bandwidth</span><br></pre></td></tr></table></figure>

<p>然后在此虚拟网卡上创建网络。这里使用两个物理网卡 <code>eth0</code> 和 <code>eth1</code> 作为 bundle，交换机上的 VLAN id 是 <code>113</code>。文件 <code>/etc/systemd/network/bond0.network</code> 内容为</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Match]</span></span><br><span class="line"><span class="attr">Name</span>=bond0</span><br><span class="line"></span><br><span class="line"><span class="section">[Network]</span></span><br><span class="line"><span class="attr">VLAN</span>=vlan113</span><br><span class="line"><span class="attr">BindCarrier</span>=eth0 eth1</span><br></pre></td></tr></table></figure>

<p>接下来分别为 <code>eth0</code> 和 <code>eth1</code> 建立网络设置。</p>
<ul>
<li><code>/etc/systemd/network/eth0.network</code></li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Match]</span></span><br><span class="line"><span class="attr">Name</span>=eth0</span><br><span class="line"></span><br><span class="line"><span class="section">[Network]</span></span><br><span class="line"><span class="attr">Bond</span>=bond0</span><br></pre></td></tr></table></figure>

<ul>
<li><code>/etc/systemd/network/eth1.network</code></li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Match]</span></span><br><span class="line"><span class="attr">Name</span>=eth1</span><br><span class="line"></span><br><span class="line"><span class="section">[Network]</span></span><br><span class="line"><span class="attr">Bond</span>=bond0</span><br></pre></td></tr></table></figure>

<p>最后是 VLAN 的设置。前面设置了上联 VLAN id 是 113，这里分别建立 VLAN 的虚拟网卡(based on bond0) 并设置网络(IP, etc)。</p>
<ul>
<li><code>/etc/systemd/network/vlan113.netdev</code></li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[NetDev]</span></span><br><span class="line"><span class="attr">Name</span>=vlan113</span><br><span class="line"><span class="attr">Kind</span>=vlan</span><br><span class="line"></span><br><span class="line"><span class="section">[VLAN]</span></span><br><span class="line"><span class="attr">Id</span>=<span class="number">113</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>/etc/systemd/network/vlan113.network</code></li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Match]</span></span><br><span class="line"><span class="attr">Name</span>=vlan113</span><br><span class="line"></span><br><span class="line"><span class="section">[Network]</span></span><br><span class="line"><span class="attr">VLAN</span>=vlan113</span><br><span class="line"></span><br><span class="line"><span class="section">[Address]</span></span><br><span class="line"><span class="attr">Address</span>=<span class="number">10.1</span>.<span class="number">0.100</span>/<span class="number">24</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Route]</span></span><br><span class="line"><span class="attr">Destination</span>=<span class="number">0.0</span>.<span class="number">0.0</span>/<span class="number">0</span></span><br><span class="line"><span class="attr">Gateway</span>=<span class="number">10.1</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">DNS</span>=<span class="number">1.1</span>.<span class="number">1.1</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Address]</span></span><br><span class="line"><span class="attr">Address</span>=<span class="number">2600</span>:x:x:x::<span class="number">2</span>/<span class="number">64</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Route]</span></span><br><span class="line"><span class="attr">Gateway</span>=<span class="number">2600</span>:x:x:x::<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>多个地址、IPv6 等可以写多个 <code>[Address]</code> 和 <code>[Route]</code>。</p>
<p>至此就完成啦。开启 systemd-networkd 的自启动：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="builtin-name">enable</span> systemd-networkd.service</span><br></pre></td></tr></table></figure>

<p>然后重启网络：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">systemctl</span> <span class="selector-tag">restart</span> <span class="selector-tag">systemd-networkd</span><span class="selector-class">.service</span></span><br></pre></td></tr></table></figure>

<p>如果配置都没有问题，网络会中断十几秒然后恢复。现在查看网卡列表已经可以看到组合的网卡了：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ip l</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode<span class="built_in"> DEFAULT group default </span>qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc mq master bond0 state UP mode<span class="built_in"> DEFAULT group default </span>qlen 1000</span><br><span class="line">    link/ether &lt;REDACTED&gt; brd ff:ff:ff:ff:ff:ff</span><br><span class="line">3: eth1: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc mq master bond0 state UP mode<span class="built_in"> DEFAULT group default </span>qlen 1000</span><br><span class="line">    link/ether &lt;REDACTED&gt; brd ff:ff:ff:ff:ff:ff</span><br><span class="line">4: eth2: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode<span class="built_in"> DEFAULT group default </span>qlen 1000</span><br><span class="line">    link/ether &lt;REDACTED&gt; brd ff:ff:ff:ff:ff:ff</span><br><span class="line">5: eno1: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode<span class="built_in"> DEFAULT group default </span>qlen 1000</span><br><span class="line">    link/ether &lt;REDACTED&gt; brd ff:ff:ff:ff:ff:ff</span><br><span class="line">6: bond0: &lt;BROADCAST,MULTICAST,MASTER,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode<span class="built_in"> DEFAULT group default </span>qlen 1000</span><br><span class="line">    link/ether &lt;REDACTED&gt; brd ff:ff:ff:ff:ff:ff</span><br><span class="line">7: vlan113@bond0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode<span class="built_in"> DEFAULT group default </span>qlen 1000</span><br><span class="line">    link/ether &lt;REDACTED&gt; brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>

<p><code>ethtool</code> 查看 <code>bond0</code> 的速率显示 <code>2000Mb/s</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ethtool bond0</span></span><br><span class="line"><span class="attr">Settings for bond0:</span></span><br><span class="line">        <span class="attr">Supported ports:</span> [ ]</span><br><span class="line">        <span class="attr">Supported link modes:</span>   <span class="string">Not</span> <span class="string">reported</span></span><br><span class="line">        <span class="attr">Supported pause frame use:</span> <span class="literal">No</span></span><br><span class="line">        <span class="attr">Supports auto-negotiation:</span> <span class="literal">No</span></span><br><span class="line">        <span class="attr">Supported FEC modes:</span> <span class="string">Not</span> <span class="string">reported</span></span><br><span class="line">        <span class="attr">Advertised link modes:</span>  <span class="string">Not</span> <span class="string">reported</span></span><br><span class="line">        <span class="attr">Advertised pause frame use:</span> <span class="literal">No</span></span><br><span class="line">        <span class="attr">Advertised auto-negotiation:</span> <span class="literal">No</span></span><br><span class="line">        <span class="attr">Advertised FEC modes:</span> <span class="string">Not</span> <span class="string">reported</span></span><br><span class="line">        <span class="attr">Speed:</span> <span class="string">2000Mb/s</span></span><br><span class="line">        <span class="attr">Duplex:</span> <span class="string">Full</span></span><br><span class="line">        <span class="attr">Port:</span> <span class="string">Other</span></span><br><span class="line">        <span class="attr">PHYAD:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">Transceiver:</span> <span class="string">internal</span></span><br><span class="line">        <span class="attr">Auto-negotiation:</span> <span class="string">off</span></span><br><span class="line">        <span class="attr">Link detected:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>

<p>搞定收工(‘・ω・’)</p>
<p>Reference:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Netctl#Bonding">Arch Linux Wiki: Netctl#Bonding</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/VLAN#systemd-networkd_bonded_interface">Arch Linux Wiki: VLAN#systemd-networkd-bonded-interface</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/systemd-networkd">Arch Linux Wiki: Systemd-networkd</a></li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2018/06/06/resize-lvm-rootfs-online/" class="prev">上一篇</a><a href="/2018/03/23/migrate-dokuwiki-to-bookstack/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'phoenixhexo';
var disqus_identifier = '2018/04/18/play-with-linux-lacp-bonding-on-vlan/';
var disqus_title = '在 Linux 服务器配置 LACP 与 VLAN';
var disqus_url = 'https://blog.phoenixlzx.com/2018/04/18/play-with-linux-lacp-bonding-on-vlan/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//phoenixhexo.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2021 <a href="https://blog.phoenixlzx.com">Phoenix Nemo</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><!--script(async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML")--><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-48847648-1",'auto');ga('send','pageview');</script></body></html>