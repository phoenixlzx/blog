<!DOCTYPE html><html lang="zh_CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 使用 Unbound 搭建更好用的 DNS 服务器 · Phoenix's island</title><meta name="description" content="使用 Unbound 搭建更好用的 DNS 服务器 - Phoenix Nemo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/null"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.phoenixlzx.com/atom.xml" title="Phoenix's island"><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="Phoenix's island" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/static/img/avatar/avatar.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINKS</a></li><li class="nav-list-item"><a href="https://github.com/phoenixlzx" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">使用 Unbound 搭建更好用的 DNS 服务器</h1><div class="post-info">2016年4月27日</div><div class="post-content"><p>用了好久的 DNSMasq 方案终于在大半年前彻底炸掉了。</p>
<p>原因不光是 DNSMasq 性能和安全性完全不足以撑起公网缓存/递归 DNS 的任务，也有想要做反污染和加速的时候确实太蛋疼的问题。</p>
<p>现在使用的方案是 Unbound+DNSCrypt，外带一份加速列表。这段时间看来，不管在我本机还是在公网服务的两台，效果和反馈都很不错。</p>
<a id="more"></a>

<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>需要的程序：</p>
<ul>
<li>unbound</li>
<li>dnscrypt-proxy</li>
<li>makefile</li>
<li>git</li>
</ul>
<p><code>makefile</code> 和 <code>git</code> 用于处理 <a target="_blank" rel="noopener" href="https://github.com/felixonmars/dnsmasq-china-list">dnsmasq-china-list</a>。</p>
<h3 id="Unbound-配置"><a href="#Unbound-配置" class="headerlink" title="Unbound 配置"></a>Unbound 配置</h3><p>修改文件 <code>/etc/unbound/unbound.conf</code>。没有这个文件的话，一般需要找一下软件包里提供的配置 example 文件复制过去。这里列出的仅包含需要修改的部分，其他的按照默认配置一般没有问题。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">num-threads:</span> <span class="number">2</span> <span class="comment"># 线程数可以修改为物理核心数</span></span><br><span class="line"><span class="attr">interface:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> <span class="comment"># 侦听所有 IPv4 地址</span></span><br><span class="line"><span class="attr">interface:</span> <span class="string">::0</span> <span class="comment"># 侦听所有 IPv6 地址</span></span><br><span class="line"><span class="comment"># 如果只需要本机使用，则一个 interface: 127.0.0.1 即可</span></span><br><span class="line"><span class="attr">so-rcvbuf:</span> <span class="string">4m</span></span><br><span class="line"><span class="attr">so-sndbuf:</span> <span class="string">4m</span> <span class="comment"># 本机使用的话，这俩 buf 可以取消注释</span></span><br><span class="line"><span class="attr">so-reuseport:</span> <span class="literal">yes</span> <span class="comment"># 如果开了多线程，就写 yes</span></span><br><span class="line"><span class="attr">msg-cache-size:</span> <span class="string">64m</span> <span class="comment"># 本机可以设置 4m 或者更小</span></span><br><span class="line"><span class="attr">rrset-cache-size:</span> <span class="string">128m</span> <span class="comment"># 本机可以设置 4m 或者更小</span></span><br><span class="line"><span class="attr">cache-max-ttl:</span> <span class="number">3600</span> <span class="comment"># 建议设置一个不太大的值...专治各种运营商 DNS 缓存不服</span></span><br><span class="line"><span class="attr">outgoing-num-tcp:</span> <span class="number">256</span> <span class="comment"># 限制每个线程向上级查询的 TCP 并发数</span></span><br><span class="line"><span class="attr">incoming-num-tcp:</span> <span class="number">1024</span> <span class="comment"># 限制每个线程接受查询的 TCP 并发数</span></span><br><span class="line"><span class="comment"># 下面这四个不需要解释了吧，不想用那个就写 no</span></span><br><span class="line"><span class="attr">do-ip4:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">do-ip6:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">do-udp:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">do-tcp:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">tcp-upstream:</span> <span class="literal">no</span> <span class="comment"># 默认是 no，隧道状态比较稳的话也不需要写 yes。一些情况下强制使用 tcp 连上游的话写 yes</span></span><br><span class="line"><span class="attr">access-control:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span> <span class="string">allow</span> <span class="comment"># 本机用的话建议设置 127.0.0.0/8 allow，局域网用适当调整</span></span><br><span class="line"><span class="attr">root-hints:</span> <span class="string">&quot;/etc/unbound/root.hints&quot;</span> <span class="comment"># 没有的话在 ftp://FTP.INTERNIC.NET/domain/named.cache 下载一份</span></span><br><span class="line"><span class="attr">hide-identity:</span> <span class="literal">yes</span> <span class="comment"># 不返回对 id.server 和 hostname.bind 的查询。</span></span><br><span class="line"><span class="attr">hide-version:</span> <span class="literal">yes</span> <span class="comment"># 不返回对 version.server 和 version.bind 的查询。</span></span><br><span class="line"><span class="comment"># 不过下面有 identity 和 version 的自定义选项，不隐藏这些的话，修改下选项还可以卖个萌(´・ω・｀)</span></span><br><span class="line"><span class="attr">harden-glue:</span> <span class="literal">yes</span> <span class="comment"># 建议打开</span></span><br><span class="line"><span class="attr">module-config:</span> <span class="string">&quot;iterator&quot;</span> <span class="comment"># 禁用 DNSSEC 检查，如果上游不支持 DNSSEC 就关掉。注意这个选项有可能在其他 include 的文件里</span></span><br><span class="line"><span class="attr">unwanted-reply-threshold:</span> <span class="number">10000000</span> <span class="comment"># 针对各种网络不服，数值为建议值，具体可以自己修改看看效果</span></span><br><span class="line"><span class="attr">do-not-query-localhost:</span> <span class="literal">no</span> <span class="comment"># 一般是为了防止扯皮丢包开着，不过等下要用 DNSCrypt 所以关掉</span></span><br><span class="line"><span class="attr">prefetch:</span> <span class="literal">yes</span> <span class="comment"># 蛮好用的，开着吧</span></span><br><span class="line"><span class="attr">minimal-responses:</span> <span class="literal">yes</span> <span class="comment"># 省带宽，开着吧。本机用可以关掉</span></span><br><span class="line"><span class="comment"># 关键部分来了，把默认查询全部丢给 DNSCrypt。使用 [地址]@[端口] 指定查询地址和端口，默认端口 53。</span></span><br><span class="line"><span class="comment"># 然后把国内的地址丢给国内的缓存服务器。这两个选项的顺序不能错哟。</span></span><br><span class="line"><span class="comment"># 如果使用隧道查询，把这个地址改为隧道对端的地址，或者一个国外的 DNS 服务器都可以，例如 8.8.8.8。</span></span><br><span class="line"><span class="comment"># 具体看是在对端开 DNS 还是直接用国外的服务器。后者的话，前面 outgoing-interface 可以直接设置隧道本地端的地址，不过要配合 dnsmasq-china-list 的话，还是写路由表比较合适，否则不够灵活。</span></span><br><span class="line"><span class="attr">include:</span> <span class="string">&quot;/etc/unbound/accelerated-domains.china.unbound.conf&quot;</span></span><br><span class="line"><span class="attr">forward-zone:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;.&quot;</span></span><br><span class="line">    <span class="attr">forward-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">@5353</span></span><br></pre></td></tr></table></figure>

<h3 id="DNSCrypt-配置"><a href="#DNSCrypt-配置" class="headerlink" title="DNSCrypt 配置"></a>DNSCrypt 配置</h3><p>修改文件 <code>/etc/default/dnscrypt-proxy</code>。</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DNSCRYPT_PROXY_LOCAL_ADDRESS=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5353</span> # 设置侦听在 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> 端口 <span class="number">5353</span>。</span><br><span class="line">DNSCRYPT_PROXY_RESOLVER_NAME=cisco # cisco 其实蛮快的，但是慢的话就去用个别的吧。d0wn 的那堆服务器真的不稳定，和名字一个样...</span><br></pre></td></tr></table></figure>

<p><strong>如果使用 systemd 的话这个文件就没用辣，看这里看这里</strong></p>
<p>修改文件 <code>/usr/lib/systemd/system/dnscrypt-proxy.socket</code>。</p>
<p>要修改的部分：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ListenStream=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5353</span></span><br><span class="line">ListenDatagram=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5353</span></span><br></pre></td></tr></table></figure>

<p><code>127.0.0.1:5353</code> 就是上面 unbound 配置里 DNSCrypt 的监听地址。</p>
<h3 id="dnsmasq-china-list-来加速"><a href="#dnsmasq-china-list-来加速" class="headerlink" title="dnsmasq-china-list 来加速"></a>dnsmasq-china-list 来加速</h3><p>首先 clone <a target="_blank" rel="noopener" href="https://github.com/felixonmars/dnsmasq-china-list.git">这个仓库</a>到本地。</p>
<p>执行 <code>make unbound</code> 来生成一份 unbound 配置，然后放在上面 unbound 配置里写的地址，也就是 <code>/etc/unbound/accelerated-domains.china.unbound.conf</code>。默认的 DNS 是 114DNS，最不太近的一段时间都挺残的所以不建议用。如果要改为其他的，例如 DNSPod PublicDNS 的话使用 <code>make SERVER=119.29.29.29 unbound</code> 即可。</p>
<p>如果还需要一些特定的缓存上游设置，要放在 <code>include: &quot;/etc/unbound/accelerated-domains.china.unbound.conf&quot;</code> 这句前面。来举一只栗子。</p>
<h3 id="举一只果子的栗子。"><a href="#举一只果子的栗子。" class="headerlink" title="举一只果子的栗子。"></a>举一只果子的栗子。</h3><p>AppStore 的加载和下载速度一直在国内饱受一些极客们的诟病，然而同时饱受诟病的运营商 DNS 解析 AppStore 的下载地址反而是国内的 CDN 地址，速度会非常快。</p>
<p>需要使用 <code>dig</code> 工具，并且要在国内的网络环境下测试。Linux 发行版里都有包可以装，OS X 则自带。</p>
<p>第一条命令：<code>dig +trace a100.phobos.apple.com.</code></p>
<p>递归追踪解析结果，这个记录被 CNAME 到了 <code>a100.phobos-apple.com.akadns.net.</code>。</p>
<p>第二条命令：<code>dig +trace a100.phobos-apple.com.akadns.net.</code>，得到这条记录被 CNAME 到了 <code>a1-a200.itunes-apple.com.akadns.net.</code>。</p>
<p>第三条命令：<code>dig +trace a1-a200.itunes-apple.com.akadns.net.</code>，看到了 CDN 的地址，<code>a1-a200.phobos.apple.chinacache.net.</code>。</p>
<p>所以如果有国内的地址直接去跟踪解析 <code>akadns.net</code> 的 DNS 的话，一般是可以正确解析到国内 CDN 的。先找一个 <code>akadns.net</code> 的权威 NS 地址，比如 <code>a1-128.akadns.net</code> 对应的 IP 是 <code>193.108.88.128</code>。同时还得有国内的 CDN 地址也从国内地址去解析，那么配置里这样写：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">forward-zone:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;akadns.net.&quot;</span></span><br><span class="line">    <span class="attr">forward-addr:</span> <span class="number">193.108</span><span class="number">.88</span><span class="number">.128</span></span><br><span class="line"><span class="attr">forward-zone:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;chinacache.net.&quot;</span></span><br><span class="line">    <span class="attr">forward-addr:</span> <span class="number">119.29</span><span class="number">.29</span><span class="number">.29</span> <span class="comment"># DNSPod PublicDNS 的服务器地址</span></span><br></pre></td></tr></table></figure>

<p>多次尝试之后，发现还有一个 CDN 地址 <code>0gq2p7eckbs26f.mwcname.com</code>，那么也把这个地址交给 unbound 通过国内网络解析。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">forward-zone:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">&quot;mwcname.com.&quot;</span></span><br><span class="line">    <span class="attr">forward-addr:</span> <span class="number">119.29</span><span class="number">.29</span><span class="number">.29</span></span><br></pre></td></tr></table></figure>

<p>一并加到上面的配置里，然后来测试下。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Phoenix-X1-Carbon</span> :: ~ » <span class="selector-tag">dig</span> <span class="keyword">@127</span>.0.0.1 a100.phobos.apple.com</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; <span class="selector-tag">DiG</span> 9<span class="selector-class">.10</span><span class="selector-class">.3-P4</span> &lt;&lt;&gt;&gt; <span class="keyword">@127</span>.0.0.1 a100.phobos.apple.com</span><br><span class="line">; (1 <span class="selector-tag">server</span> <span class="selector-tag">found</span>)</span><br><span class="line">;; <span class="selector-tag">global</span> <span class="selector-tag">options</span>: +<span class="selector-tag">cmd</span></span><br><span class="line">;; <span class="selector-tag">Got</span> <span class="selector-tag">answer</span>:</span><br><span class="line">;; <span class="selector-tag">-</span>&gt;&gt;<span class="selector-tag">HEADER</span>&lt;&lt;<span class="selector-tag">-</span> <span class="selector-tag">opcode</span>: <span class="selector-tag">QUERY</span>, <span class="selector-tag">status</span>: <span class="selector-tag">NOERROR</span>, <span class="selector-tag">id</span>: 24454</span><br><span class="line">;; <span class="selector-tag">flags</span>: <span class="selector-tag">qr</span> <span class="selector-tag">rd</span> <span class="selector-tag">ra</span>; <span class="selector-tag">QUERY</span>: 1, <span class="selector-tag">ANSWER</span>: 14, <span class="selector-tag">AUTHORITY</span>: 0, <span class="selector-tag">ADDITIONAL</span>: 1</span><br><span class="line"></span><br><span class="line">;; <span class="selector-tag">OPT</span> <span class="selector-tag">PSEUDOSECTION</span>:</span><br><span class="line">; <span class="selector-tag">EDNS</span>: <span class="selector-tag">version</span>: 0, <span class="selector-tag">flags</span>:; <span class="selector-tag">udp</span>: 4096</span><br><span class="line">;; <span class="selector-tag">QUESTION</span> <span class="selector-tag">SECTION</span>:</span><br><span class="line">;<span class="selector-tag">a100</span><span class="selector-class">.phobos</span><span class="selector-class">.apple</span><span class="selector-class">.com</span>.         <span class="selector-tag">IN</span>      <span class="selector-tag">A</span></span><br><span class="line"></span><br><span class="line">;; <span class="selector-tag">ANSWER</span> <span class="selector-tag">SECTION</span>:</span><br><span class="line"><span class="selector-tag">a100</span><span class="selector-class">.phobos</span><span class="selector-class">.apple</span><span class="selector-class">.com</span>.  3596    <span class="selector-tag">IN</span>      <span class="selector-tag">CNAME</span>   <span class="selector-tag">a100</span><span class="selector-class">.phobos-apple</span><span class="selector-class">.com</span><span class="selector-class">.akadns</span><span class="selector-class">.net</span>.</span><br><span class="line"><span class="selector-tag">a100</span><span class="selector-class">.phobos-apple</span><span class="selector-class">.com</span><span class="selector-class">.akadns</span><span class="selector-class">.net</span>. 117 <span class="selector-tag">IN</span> <span class="selector-tag">CNAME</span>  <span class="selector-tag">a1-a200</span><span class="selector-class">.itunes-apple</span><span class="selector-class">.com</span><span class="selector-class">.akadns</span><span class="selector-class">.net</span>.</span><br><span class="line"><span class="selector-tag">a1-a200</span><span class="selector-class">.itunes-apple</span><span class="selector-class">.com</span><span class="selector-class">.akadns</span><span class="selector-class">.net</span>. 297 <span class="selector-tag">IN</span> <span class="selector-tag">CNAME</span> <span class="selector-tag">a1-a200</span><span class="selector-class">.phobos</span><span class="selector-class">.apple</span><span class="selector-class">.chinacache</span><span class="selector-class">.net</span>.</span><br><span class="line"><span class="selector-tag">a1-a200</span><span class="selector-class">.phobos</span><span class="selector-class">.apple</span><span class="selector-class">.chinacache</span><span class="selector-class">.net</span>. 1799 <span class="selector-tag">IN</span> <span class="selector-tag">CNAME</span> <span class="selector-tag">a1-a200</span><span class="selector-class">.phobos</span><span class="selector-class">.apple</span><span class="selector-class">.cncssr</span><span class="selector-class">.chinacache</span><span class="selector-class">.net</span>.</span><br><span class="line"><span class="selector-tag">a1-a200</span><span class="selector-class">.phobos</span><span class="selector-class">.apple</span><span class="selector-class">.cncssr</span><span class="selector-class">.chinacache</span><span class="selector-class">.net</span>. 1799 <span class="selector-tag">IN</span> <span class="selector-tag">CNAME</span> <span class="selector-tag">cc00109</span><span class="selector-class">.h</span><span class="selector-class">.cncssr</span><span class="selector-class">.chinacache</span><span class="selector-class">.net</span>.</span><br><span class="line"><span class="selector-tag">cc00109</span><span class="selector-class">.h</span><span class="selector-class">.cncssr</span><span class="selector-class">.chinacache</span><span class="selector-class">.net</span>. 120 <span class="selector-tag">IN</span> <span class="selector-tag">A</span>       223<span class="selector-class">.99</span><span class="selector-class">.228</span><span class="selector-class">.87</span></span><br><span class="line"><span class="selector-tag">cc00109</span><span class="selector-class">.h</span><span class="selector-class">.cncssr</span><span class="selector-class">.chinacache</span><span class="selector-class">.net</span>. 120 <span class="selector-tag">IN</span> <span class="selector-tag">A</span>       113<span class="selector-class">.207</span><span class="selector-class">.33</span><span class="selector-class">.15</span></span><br><span class="line"><span class="selector-tag">cc00109</span><span class="selector-class">.h</span><span class="selector-class">.cncssr</span><span class="selector-class">.chinacache</span><span class="selector-class">.net</span>. 120 <span class="selector-tag">IN</span> <span class="selector-tag">A</span>       113<span class="selector-class">.207</span><span class="selector-class">.33</span><span class="selector-class">.12</span></span><br><span class="line"><span class="selector-tag">cc00109</span><span class="selector-class">.h</span><span class="selector-class">.cncssr</span><span class="selector-class">.chinacache</span><span class="selector-class">.net</span>. 120 <span class="selector-tag">IN</span> <span class="selector-tag">A</span>       202<span class="selector-class">.110</span><span class="selector-class">.80</span><span class="selector-class">.14</span></span><br><span class="line"><span class="selector-tag">cc00109</span><span class="selector-class">.h</span><span class="selector-class">.cncssr</span><span class="selector-class">.chinacache</span><span class="selector-class">.net</span>. 120 <span class="selector-tag">IN</span> <span class="selector-tag">A</span>       61<span class="selector-class">.179</span><span class="selector-class">.105</span><span class="selector-class">.154</span></span><br><span class="line"><span class="selector-tag">cc00109</span><span class="selector-class">.h</span><span class="selector-class">.cncssr</span><span class="selector-class">.chinacache</span><span class="selector-class">.net</span>. 120 <span class="selector-tag">IN</span> <span class="selector-tag">A</span>       61<span class="selector-class">.179</span><span class="selector-class">.105</span><span class="selector-class">.7</span></span><br><span class="line"><span class="selector-tag">cc00109</span><span class="selector-class">.h</span><span class="selector-class">.cncssr</span><span class="selector-class">.chinacache</span><span class="selector-class">.net</span>. 120 <span class="selector-tag">IN</span> <span class="selector-tag">A</span>       119<span class="selector-class">.188</span><span class="selector-class">.138</span><span class="selector-class">.172</span></span><br><span class="line"><span class="selector-tag">cc00109</span><span class="selector-class">.h</span><span class="selector-class">.cncssr</span><span class="selector-class">.chinacache</span><span class="selector-class">.net</span>. 120 <span class="selector-tag">IN</span> <span class="selector-tag">A</span>       120<span class="selector-class">.192</span><span class="selector-class">.248</span><span class="selector-class">.195</span></span><br><span class="line"><span class="selector-tag">cc00109</span><span class="selector-class">.h</span><span class="selector-class">.cncssr</span><span class="selector-class">.chinacache</span><span class="selector-class">.net</span>. 120 <span class="selector-tag">IN</span> <span class="selector-tag">A</span>       221<span class="selector-class">.181</span><span class="selector-class">.39</span><span class="selector-class">.76</span></span><br><span class="line"></span><br><span class="line">;; <span class="selector-tag">Query</span> <span class="selector-tag">time</span>: 233 <span class="selector-tag">msec</span></span><br><span class="line">;; <span class="selector-tag">SERVER</span>: 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-id">#53</span>(127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span>)</span><br><span class="line">;; <span class="selector-tag">WHEN</span>: <span class="selector-tag">Thu</span> <span class="selector-tag">Apr</span> 28 00<span class="selector-pseudo">:34</span><span class="selector-pseudo">:02</span> <span class="selector-tag">CST</span> 2016</span><br><span class="line">;; <span class="selector-tag">MSG</span> <span class="selector-tag">SIZE</span>  <span class="selector-tag">rcvd</span>: 387</span><br></pre></td></tr></table></figure>

<p>走国内 CDN 了吧~</p>
<p>重启相关服务，更改自己所用的 DNS 地址，完事儿收工(｢･ω･)｢</p>
<p>=== 2016-04-30 14:00 更新 ===</p>
<p>如果需要 <code>edns-client-subnet</code> 支持的话，需要手动编译源码安装。命令</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 克隆源码</span></span><br><span class="line">svn co http:<span class="regexp">//u</span>nbound.nlnetlabs.nl<span class="regexp">/svn/</span>branches<span class="regexp">/edns-subnet/</span></span><br><span class="line"><span class="comment"># 编译安装</span></span><br><span class="line">./configure --enable-subnet --with-libevent &amp;&amp; make &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure>

<p>配置文件的格式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认向所有服务器发送 edns-client-subnet</span></span><br><span class="line"><span class="attr">send-client-subnet:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br></pre></td></tr></table></figure>

<p>如果只对特定权威 DNS 发送 edns-client-subnet 请求，则按照此格式写多行 IP。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/08/23/my-first-yet-useless-telegram-bot/" class="prev">PREV</a><a href="/2016/04/19/fingerprint-improves-your-security-zhuangbility/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'phoenixhexo';
var disqus_identifier = '2016/04/27/better-dns-with-unbound/';
var disqus_title = '使用 Unbound 搭建更好用的 DNS 服务器';
var disqus_url = 'https://blog.phoenixlzx.com/2016/04/27/better-dns-with-unbound/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//phoenixhexo.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2023 <a href="https://blog.phoenixlzx.com">Phoenix Nemo</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><!--script(async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML")--><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-48847648-1",'auto');ga('send','pageview');</script></body></html>