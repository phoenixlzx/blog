<!DOCTYPE html><html lang="zh_CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 搭建一套权威 DNS 服务架构 · Phoenix's island</title><meta name="description" content="搭建一套权威 DNS 服务架构 - Phoenix Nemo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/null"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.phoenixlzx.com/atom.xml" title="Phoenix's island"><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="Phoenix's island" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/static/img/avatar/avatar.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINKS</a></li><li class="nav-list-item"><a href="https://github.com/phoenixlzx" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">搭建一套权威 DNS 服务架构</h1><div class="post-info">2016年9月7日</div><div class="post-content"><p><a target="_blank" rel="noopener" href="https://github.com/phoenixlzx/moedns">萌 DNS</a> 已经年久失修。尽管一直有计划完全重写出一套应用目前各种 DNS 特性和优化的完整平台，但是目前的精力不允许。所以为了先让萌 DNS 的用户们至少先有一个能支持 Let’s Encrypt 的 DNS 服务，决定暂时舍弃 GeoDNS 功能，使用一套更加成熟的解决方案提供服务。</p>
<a id="more"></a>

<p>搭配方案如下：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.powerdns.com/">PowerDNS</a></li>
<li>MySQL</li>
<li><a target="_blank" rel="noopener" href="https://github.com/ngoduykhanh/PowerDNS-Admin">PowerDNS-Admin</a></li>
<li>NGINX, Let’s Encrypt</li>
<li>Supervisor, VirtualEnv, Gunicorn, …</li>
</ul>
<p>服务器部署：</p>
<ul>
<li>管理服务器 x1<ul>
<li>MySQL Master</li>
<li>PowerDNS</li>
<li>PowerDNS-Admin, supervisor, virtualenv, gunicorn…</li>
<li>NGINX, Let’s Encrypt</li>
</ul>
</li>
<li>DNS 服务器 x4<ul>
<li>MySQL Slave</li>
<li>PowerDNS</li>
</ul>
</li>
</ul>
<p>在管理服务器上安装 PowerDNS 和 MySQL Master 的考量是由于 PowerDNS-Admin 使用 PowerDNS HTTP API，在管理服务器（或管理私网中）启动一个仅用于提供 API 和操作主数据库的 PowerDNS 实例能够减轻 Primary NS Server 的压力并提升安全性。整套架构使用 Ansible 进行自动化部署，不过好久没用了各种生疏，照着文档折腾好久的配置…</p>
<p>于是这里暂且记录下整个过程。有些坑只是作者一时疏忽或者有别的考量但没有明确记录，也许在未来的版本中会修复。</p>
<h3 id="安装-PowerDNS"><a href="#安装-PowerDNS" class="headerlink" title="安装 PowerDNS"></a>安装 PowerDNS</h3><p>所有服务器均使用 Ubuntu 16.04，需要 PowerDNS 4.0 以上的版本。按照<a target="_blank" rel="noopener" href="https://repo.powerdns.com/">此页面</a>的说明添加 PowerDNS 官方的仓库即可。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># apt install pdns-<span class="keyword">server</span> pdns-backend-mysql mysql-<span class="keyword">server</span></span><br></pre></td></tr></table></figure>

<p>由 dpkg 自动配置 PowerDNS 的数据库，然后删除 <code>/etc/powerdns/pdns.d</code> 下<strong>无关</strong>的配置文件。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># rm <span class="regexp">/etc/</span>powerdns<span class="regexp">/pdns.d/</span>pdns.local.conf</span><br><span class="line"># rm <span class="regexp">/etc/</span>powerdns<span class="regexp">/pdns.d/</span>pdns.simplebind.conf</span><br></pre></td></tr></table></figure>

<p>配置 MySQL Replication，管理服务器作为 Master，其他 DNS 服务器作为 Slave。细节不多讲，<a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/replication-howto.html">官方文档</a> 或者 <a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-master-slave-replication-in-mysql">DigitalOcean Tutorial</a>。</p>
<p>管理服务器 (MySQL Master) PowerDNS 配置文件 <code>/etc/powerdns/pdns.conf</code></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">api</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">api-key</span>=yourapisecretkey</span><br><span class="line"><span class="attribute">api-logfile</span>=/var/log/pdns-api.log</span><br><span class="line"><span class="attribute">config-dir</span>=/etc/powerdns</span><br><span class="line"><span class="attribute">guardian</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">include-dir</span>=/etc/powerdns/pdns.d</span><br><span class="line">launch=</span><br><span class="line"><span class="attribute">local-address</span>=127.0.0.1  # 不对外提供服务</span><br><span class="line"><span class="attribute">local-ipv6</span>=::1</span><br><span class="line">security-poll-suffix=</span><br><span class="line"><span class="attribute">setgid</span>=pdns</span><br><span class="line"><span class="attribute">setuid</span>=pdns</span><br><span class="line"><span class="attribute">webserver</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">webserver-address</span>=127.0.0.1  # 仅向本机的 PowerDNS-Admin 调用。如果配置在内网，请使用内网 IP</span><br><span class="line"><span class="attribute">webserver-allow-from</span>=127.0.0.1/32  # 同上，如果使用内网则写 PowerDNS-Admin 在内网的 IP</span><br><span class="line"><span class="attribute">webserver-port</span>=8081</span><br><span class="line"><span class="attribute">default-soa-name</span>=ns1.example.com  # 改为 Primary NS 的地址</span><br><span class="line"><span class="attribute">default-soa-edit</span>=INCEPTION-INCREMENT</span><br><span class="line"><span class="attribute">default-soa-mail</span>=hostmaster.example.com  # 改为默认服务器管理员的邮箱地址，并将 <span class="string">&#x27;@&#x27;</span> 替换为 <span class="string">&#x27;.&#x27;</span></span><br><span class="line"><span class="attribute">default-ttl</span>=3600</span><br></pre></td></tr></table></figure>

<p>DNS 服务器 (MySQL Slaves) PowerDNS 配置文件 <code>/etc/powerdns/pdns.conf</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">config-dir</span>=/etc/powerdns</span><br><span class="line"><span class="attr">daemon</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">disable-axfr</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">guardian</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">include-dir</span>=/etc/powerdns/pdns.d</span><br><span class="line">launch=</span><br><span class="line">security-poll-suffix=</span><br><span class="line"><span class="attr">server-id</span>=ns1.example.com  <span class="comment"># 改为当前服务器的 ID，ns1/ns2/ns3/etc...</span></span><br><span class="line"><span class="attr">setgid</span>=pdns</span><br><span class="line"><span class="attr">setuid</span>=pdns</span><br><span class="line"><span class="attr">version-string</span>=anonymous  <span class="comment"># 可以写任意字符串恶搞_(:з」∠)_</span></span><br></pre></td></tr></table></figure>

<h3 id="安装-PowerDNS-Admin"><a href="#安装-PowerDNS-Admin" class="headerlink" title="安装 PowerDNS-Admin"></a>安装 PowerDNS-Admin</h3><p>作者有提供详细的<a target="_blank" rel="noopener" href="https://github.com/ngoduykhanh/PowerDNS-Admin/wiki/Install-PowerDNS-Admin-in-Ubuntu-14.04-LTS-or-16.04-LTS">教程</a>但是还是<a target="_blank" rel="noopener" href="https://github.com/ngoduykhanh/PowerDNS-Admin/issues/126">有坑</a>。</p>
<p>安装依赖：</p>
<figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># apt install git python-pip supervisor virtualenv python-<span class="built_in">dev</span> libmysqlclient-<span class="built_in">dev</span> libsasl2-<span class="built_in">dev</span> libldap2-<span class="built_in">dev</span> libssl-<span class="built_in">dev</span> letsencrypt</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/ngoduykhanh/PowerDNS-Admin/wiki/Prepare-MySQL-or-MariaDB-Database-for-PowerDNS-Admin">创建数据库</a>，切换到普通用户权限，clone 仓库到本地，然后一步一步操作即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/ngoduykhanh/PowerDNS-Admin.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> PowerDNS-Admin</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> virtualenv flask</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">source</span> ./flask/bin/activate</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pip install -r requirements.txt</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pip install mysql gunicorn</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp config_template.py config.py</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vim config.py</span></span><br></pre></td></tr></table></figure>

<p>配置文件 <code>config.py</code> 中需要更改的地方：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">SECRET_KEY</span> = <span class="string">&#x27;yoursessionencryptkey&#x27;</span></span><br><span class="line"><span class="attr">SQLA_DB_USER</span> = <span class="string">&#x27;yourdbusername&#x27;</span></span><br><span class="line"><span class="attr">SQLA_DB_PASSWORD</span> = <span class="string">&#x27;yourdbpassword&#x27;</span></span><br><span class="line"><span class="attr">SQLA_DB_HOST</span> = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line"><span class="attr">SQLA_DB_NAME</span> = <span class="string">&#x27;yourdbname&#x27;</span></span><br><span class="line"><span class="attr">PDNS_STATS_URL</span> = <span class="string">&#x27;http://localhost:8081/&#x27;</span></span><br><span class="line"><span class="attr">PDNS_API_KEY</span> = <span class="string">&#x27;yourapisecretkey&#x27;</span></span><br><span class="line"><span class="attr">PDNS_VERSION</span> = <span class="string">&#x27;4.0.0&#x27;</span></span><br><span class="line"><span class="attr">RECORDS_ALLOW_EDIT</span> = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;AAAA&#x27;</span>, <span class="string">&#x27;CNAME&#x27;</span>, <span class="string">&#x27;SPF&#x27;</span>, <span class="string">&#x27;PTR&#x27;</span>, <span class="string">&#x27;MX&#x27;</span>, <span class="string">&#x27;TXT&#x27;</span>, <span class="string">&#x27;SRV&#x27;</span>, <span class="string">&#x27;NS&#x27;</span>, <span class="string">&#x27;SOA&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>然后执行 <code>./create_db.py</code>。如果没有报错说明数据库安装成功，执行 <code>./run.py</code> 即可访问 <code>http://127.0.0.1:9393</code> 看到登陆页面了。</p>
<h3 id="部署-Web-服务"><a href="#部署-Web-服务" class="headerlink" title="部署 Web 服务"></a>部署 Web 服务</h3><p>直接跑 <code>run.py</code> 当然不科学。Supervisor 配置文件 <code>/etc/supervisor/conf.d/pdnsadmin.conf</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[program:pdnsadmin]</span></span><br><span class="line"><span class="attr">command</span>=/home/pdns/PowerDNS-Admin/flask/bin/gunicorn run:app</span><br><span class="line"><span class="attr">directory</span>=/home/pdns/PowerDNS-Admin/</span><br><span class="line"><span class="attr">user</span>=pdns</span><br><span class="line"><span class="attr">autostart</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">stdout_logfile</span>=/var/log/supervisor/pdns-stdout.log</span><br><span class="line"><span class="attr">stdout_logfile_maxbytes</span>=<span class="number">1</span>MB</span><br><span class="line"><span class="attr">stdout_logfile_backups</span>=<span class="number">2</span></span><br><span class="line"><span class="attr">stderr_logfile</span>=/var/log/supervisor/pdns-stderr.log</span><br><span class="line"><span class="attr">stderr_logfile_maxbytes</span>=<span class="number">1</span>MB</span><br><span class="line"><span class="attr">stderr_logfile_backups</span>=<span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>创建 DHParam</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">cd</span> /etc/ssl/certs</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> openssl dhparam -out dhparam.pem 4096 <span class="comment"># 如果性能不够请使用 2048</span></span></span><br></pre></td></tr></table></figure>

<p>NGINX 配置文件 <code>/etc/nginx/site-enabled/pdnsadmin.conf</code></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> dns.example.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /.well-known &#123;</span><br><span class="line">        <span class="attribute">default_type</span> <span class="string">&quot;text/plain&quot;</span>;</span><br><span class="line">        <span class="attribute">root</span> /var/www/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">301</span> https://dns.example.com<span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_name</span> dns.example.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/letsencrypt/live/dns.example.com/fullchain.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/letsencrypt/dns.example.com/privkey.pem;</span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> <span class="string">&quot;EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !RC4&quot;</span>;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span>    <span class="number">70</span>;</span><br><span class="line">    <span class="attribute">ssl_session_cache</span>    shared:SSL:<span class="number">10m</span>;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span>  <span class="number">10m</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_dhparam</span> /etc/ssl/certs/dhparam.pem;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">add_header</span> Strict-Transport-Security max-age=<span class="number">63072000</span>;</span><br><span class="line">    <span class="attribute">add_header</span> X-Frame-Options SAMEORIGIN;</span><br><span class="line">    <span class="attribute">add_header</span> X-Content-Type-Options nosniff;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/dns.example.com.access.log;</span><br><span class="line">    <span class="attribute">error_log</span> /var/log/nginx/dns.example.com.<span class="literal">error</span>.log;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /.well-known &#123;</span><br><span class="line">        <span class="attribute">default_type</span> <span class="string">&quot;text/plain&quot;</span>;</span><br><span class="line">        <span class="attribute">root</span> /var/www/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /static &#123;</span><br><span class="line">        <span class="attribute">alias</span> /home/pdns/PowerDNS-Admin/app/static;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:8000;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> default;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forward-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">port_in_redirect</span>    <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">server_name_in_redirect</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span> <span class="number">300</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>记得把 <code>dns.example.com</code> 换成自己的域名。</p>
<p>签发 Let’s Encrypt。也不多讲。NGINX 配置中已经有了针对 Let’s Encrypt 的续期设置。</p>
<p>然后重启各项服务</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># systemctl restart supervisor</span></span><br><span class="line"><span class="meta"># systemctl restart nginx</span></span><br></pre></td></tr></table></figure>

<p>查看 PowerDNS-Admin 的运行状态，使用 <code>supervisorctl status</code>。</p>
<h3 id="添加-GLUE-记录"><a href="#添加-GLUE-记录" class="headerlink" title="添加 GLUE 记录"></a>添加 GLUE 记录</h3><p>要使自己的 NS 生效，必须有保存在上级 NS 中的记录。很多域名注册商都提供了配置 GLUE 记录的功能，例如 Hexonet (1API):</p>
<p><img src="/static/img/posts/2016-09-07-glue.jpg" alt="Glue Records"></p>
<p>简言之，需要把自己的 NS 服务器及对应的 IP 记录到上级 NS。完成之后，通过 PowerDNS-Admin 添加自己的域名，zone 类型为 <code>NATIVE</code>。然后添加所有 NS 服务器的 A/AAAA 以及所有的 NS 记录——你没听错，要自己写 NS 记录。其他域名也需要添加这些 NS 记录，否则不会托管。</p>
<p><img src="/static/img/posts/2016-09-07-ns.jpg" alt="Glue Records"></p>
<h3 id="收尾"><a href="#收尾" class="headerlink" title="收尾"></a>收尾</h3><p>全部完成之后就是一个完整功能的 DNS 服务了。如果希望启用 DNSSEC，需要在管理服务器中通过 <code>pdnsutil</code> 来添加 key。</p>
<p>由于目前 PowerDNS-Admin 没有限制不能添加提供的 NS 之外的名称服务器，所以其他域名按照添加 GLUE 记录的方法，也可以将这些 NS 服务器「变成」自己的 NS。</p>
<p>好了，不会说话了。讲效果——</p>
<p>一般来说，DNS 服务都会提供多台 NS 服务器域名，将域名的 DNS 改为这些 NS 服务器才能托管到该 DNS 服务上。但是现在只需要知道这套 DNS 的服务器 IP 地址，即可给自己的域名添加 GLUE 记录、NS 记录和 NS 对应的 A/AAAA 记录进而使用自己的域名作为 NS，而不需要用 DNS 服务的 NS 域名。当然一般就是看起来会比较厉害而已…</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/12/12/infinite-zheteng-switch-to-gcp/" class="prev">PREV</a><a href="/2016/08/23/my-first-yet-useless-telegram-bot/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'phoenixhexo';
var disqus_identifier = '2016/09/07/powerdns-admin-replacing-moedns/';
var disqus_title = '搭建一套权威 DNS 服务架构';
var disqus_url = 'https://blog.phoenixlzx.com/2016/09/07/powerdns-admin-replacing-moedns/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//phoenixhexo.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2020 <a href="https://blog.phoenixlzx.com">Phoenix Nemo</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><!--script(async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML")--><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-48847648-1",'auto');ga('send','pageview');</script></body></html>