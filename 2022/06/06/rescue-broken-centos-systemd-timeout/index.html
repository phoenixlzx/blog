<!DOCTYPE html><html lang="zh_CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 修复 CentOS 'org.freedesktop.login1' timed out · Phoenix's island</title><meta name="description" content="修复 CentOS 'org.freedesktop.login1' timed out - Phoenix Nemo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/null"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.phoenixlzx.com/atom.xml" title="Phoenix's island"><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="Phoenix's island" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/static/img/avatar/avatar.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINKS</a></li><li class="nav-list-item"><a href="https://github.com/phoenixlzx" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">修复 CentOS 'org.freedesktop.login1' timed out</h1><div class="post-info">2022年6月6日</div><div class="post-content"><p>又到了喜闻乐见帮人修系统的时间。</p>
<a id="more"></a>

<p>根据情况描述是 “stuck at ‘Starting switch root’”，初步判定是 initramfs 坏掉了。经过询问果不其然，某个特别爱没事儿就更新的家伙在更新的时候被数据中心的智障远程手按了电源¯(ツ)/¯</p>
<p>既然启动不能那就进 Rescue 呗。虽然 CentOS 这系统不怎么样，但是至少也算在原版 ISO 就提供了 Rescue 的选项，还能自动寻找根分区挂载。本来以为小事一桩，准备 chroot 的时候突然冒出来一句 “chroot: cannot run command `/bin/sh’: Exec format error” 就瞬间心里一顿$#%#$^$#@#%#</p>
<p>一般来讲，报错 “Exec format error” 代表二进制格式错误，例如在 32 位系统中执行 64 位二进制文件。但这不可能，首先同样是 x86_64 架构，安装的系统和 ISO 的系统也是同样的版本，磁盘也没有报错，为什么会出现这种问题？</p>
<p>更新时断电导致文件被写坏的可能性并不是没有，但奇怪的是执行 <code>/bin/bash</code> 也报一样的错误。能坏到这种程度怕不是 glibc 挂了…？但总之第一步是要能先进系统瞧瞧究竟，于是心一横，直接用 Live CD 的 <code>/usr</code> 覆盖磁盘上的对应目录。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~&gt; cp -r <span class="regexp">/usr /m</span>nt<span class="regexp">/sysimage/</span></span><br></pre></td></tr></table></figure>

<p>然后再 chroot，果然成功进入系统，<code>yum</code> 命令也可以用了。既然是更新过程中断电，那应该先尝试修复未完成的更新。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~&gt; yum-complete-transaction</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Loading<span class="built_in"> mirror </span>speeds <span class="keyword">from</span> cached hostfile</span><br><span class="line"><span class="literal">No</span> unfinished transactions left.</span><br></pre></td></tr></table></figure>

<p>啊咧。</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">~&gt; yum update</span><br><span class="line"><span class="comment">--&gt; Finished Dependency Resolution</span></span><br><span class="line">Error:  Multilib <span class="built_in">version</span> problems found. This often means <span class="keyword">that</span> <span class="keyword">the</span> root</span><br><span class="line">       cause <span class="keyword">is</span> something <span class="keyword">else</span> <span class="keyword">and</span> multilib <span class="built_in">version</span> checking <span class="keyword">is</span> just</span><br><span class="line">       pointing out <span class="keyword">that</span> there <span class="keyword">is</span> a problem. Eg.:</span><br><span class="line"></span><br><span class="line">         <span class="number">1.</span> You have an upgrade <span class="keyword">for</span> libselinux which <span class="keyword">is</span> missing <span class="keyword">some</span></span><br><span class="line">            dependency <span class="keyword">that</span> another package requires. Yum <span class="keyword">is</span> trying <span class="keyword">to</span></span><br><span class="line">            solve this <span class="keyword">by</span> installing an older <span class="built_in">version</span> <span class="keyword">of</span> glibc <span class="keyword">of</span> <span class="keyword">the</span></span><br><span class="line">            different architecture. If you exclude <span class="keyword">the</span> bad architecture</span><br><span class="line">            yum will <span class="keyword">tell</span> you what <span class="keyword">the</span> root cause <span class="keyword">is</span> (which package</span><br><span class="line">            requires what). You can <span class="keyword">try</span> redoing <span class="keyword">the</span> upgrade <span class="keyword">with</span></span><br><span class="line">            <span class="comment">--exclude glibc.otherarch ... this should give you an error</span></span><br><span class="line">            message showing <span class="keyword">the</span> root cause <span class="keyword">of</span> <span class="keyword">the</span> problem.</span><br><span class="line"></span><br><span class="line">         <span class="number">2.</span> You have multiple architectures <span class="keyword">of</span> glibc installed, <span class="keyword">but</span></span><br><span class="line">            yum can only see an upgrade <span class="keyword">for</span> one <span class="keyword">of</span> those arcitectures.</span><br><span class="line">            If you don&#x27;t want/need both architectures anymore <span class="keyword">then</span> you</span><br><span class="line">            can remove <span class="keyword">the</span> one <span class="keyword">with</span> <span class="keyword">the</span> missing update <span class="keyword">and</span> everything</span><br><span class="line">            will work.</span><br><span class="line"></span><br><span class="line">         <span class="number">3.</span> You have duplicate versions <span class="keyword">of</span> glibc installed already.</span><br><span class="line">            You can use <span class="string">&quot;yum check&quot;</span> <span class="keyword">to</span> <span class="keyword">get</span> yum show these errors.</span><br><span class="line"></span><br><span class="line">       ...you can also use <span class="comment">--setopt=protected_multilib=false to remove</span></span><br><span class="line">       this checking, however this <span class="keyword">is</span> almost never <span class="keyword">the</span> correct thing <span class="keyword">to</span></span><br><span class="line">       do <span class="keyword">as</span> something <span class="keyword">else</span> <span class="keyword">is</span> very likely <span class="keyword">to</span> go wrong (often causing</span><br><span class="line">       much more problems).</span><br><span class="line"></span><br><span class="line">       Protected multilib versions: glibc..... != glibc.....</span><br><span class="line">       kbd... x86_64 != kbd ... x86_64</span><br></pre></td></tr></table></figure>

<p>…还真是。</p>
<p>进一步了解到这个系统并没有安装 32 位包，那么这个 32 位的 glibc 是哪儿来的呢？<code>yum check</code> 无果，更何况还有一个奇怪的 kbd 包甚至跟 32 位毫无关系。看来坏的不轻，但是既然确定系统中没有 32 位包，那么可以继续莽到底了。</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 完成所有未更新的包</span></span><br><span class="line"><span class="function">~&gt;</span> yum update --setopt=protected_multilib=<span class="literal">false</span></span><br><span class="line"><span class="comment"># 为重装系统做准备</span></span><br><span class="line"><span class="function">~&gt;</span> mkdir /root/tmp</span><br><span class="line"><span class="function">~&gt;</span> cd /root/tmp</span><br><span class="line"><span class="comment"># 重装所有包</span></span><br><span class="line"><span class="function">~&gt;</span> yum reinstall * --setopt=protected_multilib=<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>一通操作猛如虎，第一次重装所有包时还会报错 ldconfig 一些库是空文件，第二次完整重装就看不到报错了。看来可行，果断重启，一堆 OK 之后看到了 login 提示。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">localhost <span class="keyword">login</span>: root</span><br><span class="line"></span><br><span class="line"><span class="keyword">Login</span> incorrect</span><br><span class="line"></span><br><span class="line"><span class="keyword">Login</span> incorrect</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">Login</span> incorrect</span><br></pre></td></tr></table></figure>

<p>嗯嗯嗯？？？我还没输入密码呢？？？</p>
<p>还没输入密码就报错，至少不是 PAM 的问题。在那之前呢？应该是 systemd-logind 了。幸运的是网络可以正常启动，SSH 能够正常登入系统。如果网络或者 SSH 也不行，那就只好再次进 rescue 了。</p>
<p>系统里很多本来应该有的底层服务没有启动，例如 systemd-logind。想查看这货的状态，结果报错：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed <span class="keyword">to</span> activate<span class="built_in"> service </span><span class="string">&#x27;org.freedesktop.systemd1&#x27;</span>: timed out</span><br></pre></td></tr></table></figure>

<p>咦？systemd 自己都没正常启动，看看日志：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">localhost dbus-daemon[1166]: Encountered <span class="keyword">error</span> &#x27;<span class="keyword">Error</span> <span class="keyword">in</span> <span class="keyword">file</span> /etc/dbus-1/system.<span class="keyword">d</span>/org.freedesktop.hostname1.<span class="keyword">conf</span>, <span class="keyword">line</span> 1, column 0: <span class="keyword">no</span> element found</span><br><span class="line">                                                  &#x27; <span class="keyword">while</span> parsing &#x27;/etc/dbus-1/system.<span class="keyword">d</span>/org.freedesktop.hostname1.<span class="keyword">conf</span>&#x27;</span><br><span class="line">localhost dbus-daemon[1166]: Encountered <span class="keyword">error</span> &#x27;<span class="keyword">Error</span> <span class="keyword">in</span> <span class="keyword">file</span> /etc/dbus-1/system.<span class="keyword">d</span>/org.freedesktop.import1.<span class="keyword">conf</span>, <span class="keyword">line</span> 1, column 0: <span class="keyword">no</span> element found</span><br><span class="line">                                                  &#x27; <span class="keyword">while</span> parsing &#x27;/etc/dbus-1/system.<span class="keyword">d</span>/org.freedesktop.import1.<span class="keyword">conf</span>&#x27;</span><br><span class="line">localhost dbus-daemon[1166]: Encountered <span class="keyword">error</span> &#x27;<span class="keyword">Error</span> <span class="keyword">in</span> <span class="keyword">file</span> /etc/dbus-1/system.<span class="keyword">d</span>/org.freedesktop.locale1.<span class="keyword">conf</span>, <span class="keyword">line</span> 1, column 0: <span class="keyword">no</span> element found</span><br><span class="line">                                                  &#x27; <span class="keyword">while</span> parsing &#x27;/etc/dbus-1/system.<span class="keyword">d</span>/org.freedesktop.locale1.<span class="keyword">conf</span>&#x27;</span><br><span class="line">localhost dbus-daemon[1166]: Encountered <span class="keyword">error</span> &#x27;<span class="keyword">Error</span> <span class="keyword">in</span> <span class="keyword">file</span> /etc/dbus-1/system.<span class="keyword">d</span>/org.freedesktop.login1.<span class="keyword">conf</span>, <span class="keyword">line</span> 1, column 0: <span class="keyword">no</span> element found</span><br><span class="line">                                                  &#x27; <span class="keyword">while</span> parsing &#x27;/etc/dbus-1/system.<span class="keyword">d</span>/org.freedesktop.login1.<span class="keyword">conf</span>&#x27;</span><br><span class="line">localhost dbus-daemon[1166]: Encountered <span class="keyword">error</span> &#x27;<span class="keyword">Error</span> <span class="keyword">in</span> <span class="keyword">file</span> /etc/dbus-1/system.<span class="keyword">d</span>/org.freedesktop.machine1.<span class="keyword">conf</span>, <span class="keyword">line</span> 1, column 0: <span class="keyword">no</span> element found</span><br><span class="line">                                                  &#x27; <span class="keyword">while</span> parsing &#x27;/etc/dbus-1/system.<span class="keyword">d</span>/org.freedesktop.machine1.<span class="keyword">conf</span>&#x27;</span><br><span class="line">localhost dbus-daemon[1166]: Encountered <span class="keyword">error</span> &#x27;<span class="keyword">Error</span> <span class="keyword">in</span> <span class="keyword">file</span> /etc/dbus-1/system.<span class="keyword">d</span>/org.freedesktop.systemd1.<span class="keyword">conf</span>, <span class="keyword">line</span> 1, column 0: <span class="keyword">no</span> element found</span><br><span class="line">                                                  &#x27; <span class="keyword">while</span> parsing &#x27;/etc/dbus-1/system.<span class="keyword">d</span>/org.freedesktop.systemd1.<span class="keyword">conf</span>&#x27;</span><br><span class="line">localhost dbus-daemon[1166]: Encountered <span class="keyword">error</span> &#x27;<span class="keyword">Error</span> <span class="keyword">in</span> <span class="keyword">file</span> /etc/dbus-1/system.<span class="keyword">d</span>/org.freedesktop.timedate1.<span class="keyword">conf</span>, <span class="keyword">line</span> 1, column 0: <span class="keyword">no</span> element found</span><br><span class="line">                                                  &#x27; <span class="keyword">while</span> parsing &#x27;/etc/dbus-1/system.<span class="keyword">d</span>/org.freedesktop.timedate1.<span class="keyword">conf</span>&#x27;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>病的不轻。这些文件内容消失了，重装包并不会覆盖它们。只好手动来覆盖了。</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装必要工具</span></span><br><span class="line"><span class="function">~&gt;</span> yum install yum-utils rpm2cpio</span><br><span class="line"><span class="comment"># 获取并解包 rpm</span></span><br><span class="line"><span class="function">~&gt;</span> cd /root/tmp</span><br><span class="line"><span class="function">~&gt;</span> yumdownloader dbus systemd</span><br><span class="line"><span class="function">~&gt;</span> rpm2cpio dbus-<span class="number">1.10</span>.<span class="number">24</span>-<span class="number">15.el</span>7.x86_64.rpm | cpio -idmv</span><br><span class="line"><span class="function">~&gt;</span> rpm2cpio systemd-<span class="number">219</span>-<span class="number">78.el</span>7_9.<span class="number">5.x</span>86_64.rpm | cpio -idmv</span><br></pre></td></tr></table></figure>

<p>于是得到了这些包的内容。手动将 <code>etc/dbus-1</code> 目录下的所有文件覆盖到文件系统，然后执行 <code>kill 1</code></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">localhost systemd[1]: Received SIGTERM <span class="keyword">from</span> PID 4332 (bash).</span><br><span class="line">localhost systemd[1]: Reexecuting.</span><br><span class="line">localhost systemd[1]: systemd 219 running <span class="keyword">in</span><span class="built_in"> system </span>mode. (+PAM +AUDIT +SELINUX +IMA -APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ</span><br><span class="line">localhost systemd[1]: Detected architecture x86-64.</span><br><span class="line">localhost dbus[1166]: [system] Successfully activated<span class="built_in"> service </span><span class="string">&#x27;org.freedesktop.systemd1&#x27;</span></span><br><span class="line">localhost systemd[1]: Started Login Service.</span><br><span class="line">localhost systemd-logind[4723]: New seat seat0.</span><br></pre></td></tr></table></figure>

<p>仔细检查一遍，各种服务都在正常启动了！</p>
<p>(๑•̀ㅂ•́)و✧</p>
<p>后记：别没事儿更新生产用系统。</p>
<p>后记 2：西方国家的数据中心远程手没有一个靠谱的。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2023/06/27/remote-flash-h330-to-hba/" class="prev">PREV</a><a href="/2021/12/02/protect-proxmox-ve-with-fail2ban/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'phoenixhexo';
var disqus_identifier = '2022/06/06/rescue-broken-centos-systemd-timeout/';
var disqus_title = '修复 CentOS 'org.freedesktop.login1' timed out';
var disqus_url = 'https://blog.phoenixlzx.com/2022/06/06/rescue-broken-centos-systemd-timeout/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//phoenixhexo.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2023 <a href="https://blog.phoenixlzx.com">Phoenix Nemo</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><!--script(async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML")--><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-48847648-1",'auto');ga('send','pageview');</script></body></html>