<!DOCTYPE html><html lang="zh_CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 修复 LVM XFS 的 Input/output error · Phoenix's island</title><meta name="description" content="修复 LVM XFS 的 Input/output error - Phoenix Nemo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/null"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.phoenixlzx.com/atom.xml" title="Phoenix's island"><meta name="generator" content="Hexo 5.1.1"><link rel="alternate" href="/atom.xml" title="Phoenix's island" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/static/img/avatar/avatar.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINKS</a></li><li class="nav-list-item"><a href="https://github.com/phoenixlzx" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">修复 LVM XFS 的 Input/output error</h1><div class="post-info">2021年7月7日</div><div class="post-content"><p>某服务挂了。</p>
<p>设备被强制重启之后发现 LVM 满了，但是文件无法访问，所有文件操作显示 <code>Input/output error</code>。</p>
<a id="more"></a>

<p>查看 <code>dmesg</code> 发现大量文件系统错误，应该是磁盘写满后仍有进程不断读写的过程中被强制断电的结果。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[ 1714.217864] XFS (dm-0):<span class="built_in"> page </span>discard on<span class="built_in"> page </span>00000000161e11d5, inode 0xd861b703d, offset 937984.</span><br><span class="line">[ 1714.219674] XFS (dm-0):<span class="built_in"> page </span>discard on<span class="built_in"> page </span>000000001d433e5e, inode 0xd861b703d, offset 942080.</span><br><span class="line">[ 1714.221132] XFS (dm-0):<span class="built_in"> page </span>discard on<span class="built_in"> page </span>00000000820efe8d, inode 0xd861b703d, offset 946176.</span><br><span class="line">[ 1714.222431] XFS (dm-0):<span class="built_in"> page </span>discard on<span class="built_in"> page </span>00000000518c8216, inode 0xd861b703d, offset 950272.</span><br><span class="line">[ 1714.223744] XFS (dm-0):<span class="built_in"> page </span>discard on<span class="built_in"> page </span>00000000753db760, inode 0xd861b703d, offset 954368.</span><br><span class="line">[ 1714.225041] XFS (dm-0):<span class="built_in"> page </span>discard on<span class="built_in"> page </span>00000000da40787d, inode 0xd861b703d, offset 958464.</span><br><span class="line">[ 1714.226341] XFS (dm-0):<span class="built_in"> page </span>discard on<span class="built_in"> page </span>00000000ba8adb4b, inode 0xd861b703d, offset 962560.</span><br><span class="line">[ 1714.227629] XFS (dm-0):<span class="built_in"> page </span>discard on<span class="built_in"> page </span>00000000784c4724, inode 0xd861b703d, offset 966656.</span><br><span class="line">[ 1714.228923] XFS (dm-0):<span class="built_in"> page </span>discard on<span class="built_in"> page </span>0000000063b2c764, inode 0xd861b703d, offset 970752.</span><br><span class="line">[ 1714.228990] XFS (dm-0):<span class="built_in"> page </span>discard on<span class="built_in"> page </span>0000000046a36fd8, inode 0xd861b703d, offset 974848.</span><br><span class="line">[ 1714.337426] dm-0: writeback <span class="builtin-name">error</span> on inode 58084519997, offset 905216, sector 34365282240</span><br><span class="line">[ 1716.586318] dm-0: writeback <span class="builtin-name">error</span> on inode 58084519997, offset 905216, sector 34365309816</span><br><span class="line">[ 1728.444718] xfs_discard_page: 9674 callbacks suppressed</span><br><span class="line"></span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line"></span><br><span class="line">[ 1763.990454] XFS (dm-0): xfs_do_force_shutdown(0x8) called <span class="keyword">from</span> line 955 of file fs/xfs/xfs_trans.c. Return<span class="built_in"> address </span>= 00000000ea9478e4</span><br><span class="line">[ 1763.990459] XFS (dm-0): Corruption of in-memory data detected.  Shutting down filesystem</span><br><span class="line">[ 1763.992696] XFS (dm-0): Please unmount the filesystem <span class="keyword">and</span> rectify the problem(s)</span><br></pre></td></tr></table></figure>

<p>日志写的很清楚了，那就来卸载修复吧</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~&gt; umount /<span class="class"><span class="keyword">data</span></span></span><br><span class="line">~&gt; xfs_repair /dev/mapper/<span class="class"><span class="keyword">data</span></span></span><br></pre></td></tr></table></figure>

<p>显示</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Phase <span class="number">1</span> - find <span class="keyword">and</span> verify superblock...</span><br><span class="line">        - reporting progress <span class="keyword">in</span> intervals <span class="keyword">of</span> <span class="number">15</span> minutes</span><br><span class="line">Phase <span class="number">2</span> - <span class="keyword">using</span> internal <span class="built_in">log</span></span><br><span class="line">        - <span class="literal">zero</span> <span class="built_in">log</span>...</span><br><span class="line">ERROR: The filesystem has valuable metadata changes <span class="keyword">in</span> <span class="keyword">a</span> <span class="built_in">log</span> which needs <span class="built_in">to</span></span><br><span class="line">be replayed.  Mount <span class="keyword">the</span> filesystem <span class="built_in">to</span> replay <span class="keyword">the</span> <span class="built_in">log</span>, <span class="keyword">and</span> unmount <span class="keyword">it</span> <span class="keyword">before</span></span><br><span class="line">re-running xfs_repair.  If you are unable <span class="built_in">to</span> mount <span class="keyword">the</span> filesystem, <span class="keyword">then</span> use</span><br><span class="line"><span class="keyword">the</span> -L option <span class="built_in">to</span> destroy <span class="keyword">the</span> <span class="built_in">log</span> <span class="keyword">and</span> attempt <span class="keyword">a</span> repair.</span><br><span class="line">Note that destroying <span class="keyword">the</span> <span class="built_in">log</span> may cause corruption <span class="comment">-- please attempt a mount</span></span><br><span class="line"><span class="keyword">of</span> <span class="keyword">the</span> filesystem <span class="keyword">before</span> doing this.</span><br></pre></td></tr></table></figure>

<p>咦，为什么还要我 remount。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~&gt; mount -a</span><br><span class="line">~&gt; umount /<span class="class"><span class="keyword">data</span></span></span><br><span class="line">~&gt; xfs_repair /dev/mapper/<span class="class"><span class="keyword">data</span></span></span><br></pre></td></tr></table></figure>

<p>然后就是漫长的等待…（因为是 HDD）</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">Phase <span class="number">1</span> - find <span class="keyword">and</span> verify superblock...</span><br><span class="line">        - reporting progress <span class="keyword">in</span> <span class="built_in">int</span>ervals of <span class="number">15</span> minutes</span><br><span class="line">Phase <span class="number">2</span> - using <span class="built_in">int</span>ernal log</span><br><span class="line">        - zero log...</span><br><span class="line">        - <span class="number">19</span>:<span class="number">33</span>:<span class="number">58</span>: zeroing log - <span class="number">521728</span> of <span class="number">521728</span> blocks done</span><br><span class="line">        - scan filesystem freespace <span class="keyword">and</span> inode maps...</span><br><span class="line">        - <span class="number">19</span>:<span class="number">34</span>:<span class="number">11</span>: scanning filesystem freespace - <span class="number">33</span> of <span class="number">33</span> allocation groups done</span><br><span class="line">        - found root inode chunk</span><br><span class="line">Phase <span class="number">3</span> - <span class="keyword">for</span> each AG...</span><br><span class="line">        - scan <span class="keyword">and</span> clear agi unlinked lists...</span><br><span class="line">        - <span class="number">19</span>:<span class="number">34</span>:<span class="number">11</span>: scanning agi unlinked lists - <span class="number">33</span> of <span class="number">33</span> allocation groups done</span><br><span class="line">        - process known inodes <span class="keyword">and</span> perform inode discovery...</span><br><span class="line">        - agno = <span class="number">0</span></span><br><span class="line">        - agno = <span class="number">15</span></span><br><span class="line">        - agno = <span class="number">30</span></span><br><span class="line">        ...</span><br><span class="line">        - agno = <span class="number">27</span></span><br><span class="line">        - agno = <span class="number">28</span></span><br><span class="line">        - agno = <span class="number">29</span></span><br><span class="line">        - <span class="number">19</span>:<span class="number">43</span>:<span class="number">14</span>: process known inodes <span class="keyword">and</span> inode discovery - <span class="number">16555072</span> of <span class="number">16555072</span> inodes done</span><br><span class="line">        - process newly discovered inodes...</span><br><span class="line">        - <span class="number">19</span>:<span class="number">43</span>:<span class="number">14</span>: process newly discovered inodes - <span class="number">33</span> of <span class="number">33</span> allocation groups done</span><br><span class="line">Phase <span class="number">4</span> - check <span class="keyword">for</span> duplicate blocks...</span><br><span class="line">        - setting up duplicate extent list...</span><br><span class="line">        - <span class="number">19</span>:<span class="number">43</span>:<span class="number">15</span>: setting up duplicate extent list - <span class="number">33</span> of <span class="number">33</span> allocation groups done</span><br><span class="line">        - check <span class="keyword">for</span> inodes claiming duplicate blocks...</span><br><span class="line">        - agno = <span class="number">7</span></span><br><span class="line">        - agno = <span class="number">3</span></span><br><span class="line">        - agno = <span class="number">8</span></span><br><span class="line">        ...</span><br><span class="line">        - agno = <span class="number">30</span></span><br><span class="line">        - agno = <span class="number">31</span></span><br><span class="line">        - agno = <span class="number">32</span></span><br><span class="line">        - <span class="number">19</span>:<span class="number">43</span>:<span class="number">24</span>: check <span class="keyword">for</span> inodes claiming duplicate blocks - <span class="number">16555072</span> of <span class="number">16555072</span> inodes done</span><br><span class="line">Phase <span class="number">5</span> - rebuild AG headers <span class="keyword">and</span> trees...</span><br><span class="line">        - <span class="number">19</span>:<span class="number">43</span>:<span class="number">27</span>: rebuild AG headers <span class="keyword">and</span> trees - <span class="number">33</span> of <span class="number">33</span> allocation groups done</span><br><span class="line">        - reset superblock...</span><br><span class="line">Phase <span class="number">6</span> - check inode connectivity...</span><br><span class="line">        - resetting contents of realtime bitmap <span class="keyword">and</span> summary inodes</span><br><span class="line">        - traversing filesystem ...</span><br><span class="line">        - <span class="number">19</span>:<span class="number">48</span>:<span class="number">58</span>: rebuild AG headers <span class="keyword">and</span> trees - <span class="number">33</span> of <span class="number">33</span> allocation groups done</span><br><span class="line">        - traversal finished ...</span><br><span class="line">        - moving disconnected inodes to lost+found ...</span><br><span class="line">Phase <span class="number">7</span> - verify <span class="keyword">and</span> correct link counts...</span><br><span class="line">        - <span class="number">19</span>:<span class="number">50</span>:<span class="number">02</span>: verify <span class="keyword">and</span> correct link counts - <span class="number">33</span> of <span class="number">33</span> allocation groups done</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>完事后重启，就可以重新访问 LVM 里的文件啦。</p>
<p>后记：</p>
<p>这次所幸根分区是单独的盘，如果根分区和 LVM 在同一块物理盘上的话，需要重启系统进入救援模式，手动激活 LVM 再执行修复。</p>
<p>以及 XFS 还是靠谱呀（<del>看向某每天摸鱼看番剧透的 btrfs 开发者</del></p>
</div></article></div></section><footer><div class="paginator"><a href="/2021/11/09/basic-ipxe-boot-archlinux/" class="prev">PREV</a><a href="/2021/04/12/difference-between-fat32/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'phoenixhexo';
var disqus_identifier = '2021/07/07/fix-lvm-xfs-input-output-error/';
var disqus_title = '修复 LVM XFS 的 Input/output error';
var disqus_url = 'https://blog.phoenixlzx.com/2021/07/07/fix-lvm-xfs-input-output-error/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//phoenixhexo.disqus.com/count.js" async></script><div class="copyright"><p>© 2014 - 2023 <a href="https://blog.phoenixlzx.com">Phoenix Nemo</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><!--script(async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML")--><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-48847648-1",'auto');ga('send','pageview');</script></body></html>